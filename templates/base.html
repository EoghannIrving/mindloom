<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="{{ static_url(request, 'manifest.webmanifest') }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ static_url(request, 'icons/icon-192.png') }}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111827">
  <title>{% block title %}Mindloom{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    select option {
      color: #0f172a;
    }
  </style>
  <script>
    (function () {
      const feedbackVariants = {
        info: [
          'rounded-lg',
          'border',
          'border-indigo-200',
          'bg-indigo-50',
          'text-indigo-700',
          'px-3',
          'py-2',
        ],
        success: [
          'rounded-lg',
          'border',
          'border-emerald-200',
          'bg-emerald-50',
          'text-emerald-700',
          'px-3',
          'py-2',
        ],
        error: [
          'rounded-lg',
          'border',
          'border-rose-200',
          'bg-rose-50',
          'text-rose-700',
          'px-3',
          'py-2',
        ],
      };

      const invalidFieldClasses = ['border-rose-400', 'ring-2', 'ring-rose-200', 'bg-rose-50'];

      function resolveElement(target) {
        if (!target) {
          return null;
        }
        if (typeof target === 'string') {
          return document.getElementById(target);
        }
        return target;
      }

      function setPreContent(target, text) {
        const el = resolveElement(target);
        if (!el) {
          return;
        }
        el.textContent = text;
        if (el.classList.contains('data-placeholder')) {
          const placeholderClass = el.dataset.placeholderClass;
          if (placeholderClass) {
            el.classList.remove(placeholderClass);
          }
          const activeClass = el.dataset.activeClass;
          if (activeClass) {
            el.classList.add(activeClass);
          }
          el.classList.remove('data-placeholder');
        }
      }

      function isPlaceholder(target) {
        const el = resolveElement(target);
        return !!el && el.classList.contains('data-placeholder');
      }

      function resetFeedbackClasses(el) {
        Object.values(feedbackVariants).forEach((classes) => {
          classes.forEach((cls) => el.classList.remove(cls));
        });
      }

      function updateFeedback(target, message, variant = 'info') {
        const el = resolveElement(target);
        if (!el) {
          return;
        }
        el.classList.remove('hidden');
        el.textContent = message;
        resetFeedbackClasses(el);
        const classes = feedbackVariants[variant] || feedbackVariants.info;
        el.classList.add(...classes);
        el.setAttribute('role', variant === 'error' ? 'alert' : 'status');
      }

      function clearFeedback(target) {
        const el = resolveElement(target);
        if (!el) {
          return;
        }
        resetFeedbackClasses(el);
        el.textContent = '';
        el.classList.add('hidden');
        el.removeAttribute('role');
      }

      function setFieldValidity(field, isValid) {
        if (!field) {
          return;
        }
        const el = resolveElement(field);
        if (!el) {
          return;
        }
        if (isValid) {
          el.removeAttribute('aria-invalid');
          invalidFieldClasses.forEach((cls) => el.classList.remove(cls));
        } else {
          el.setAttribute('aria-invalid', 'true');
          invalidFieldClasses.forEach((cls) => el.classList.add(cls));
        }
      }

      function attachFieldValidation(field) {
        const el = resolveElement(field);
        if (!el) {
          return;
        }
        ['input', 'change', 'blur'].forEach((eventName) => {
          el.addEventListener(eventName, () => {
            setFieldValidity(el, true);
          });
        });
      }

      function validateRequiredFields(fields, options = {}) {
        const { feedbackEl, summaryMessage } = options;
        let isValid = true;
        fields.forEach((fieldConfig) => {
          const { element, message } = fieldConfig;
          const el = resolveElement(element);
          if (!el) {
            return;
          }
          const value = (el.value ?? '').toString().trim();
          if (!value) {
            isValid = false;
            setFieldValidity(el, false);
            if (message) {
              el.setAttribute('title', message);
            }
          } else {
            setFieldValidity(el, true);
            if (message) {
              el.removeAttribute('title');
            }
          }
        });
        if (!isValid && feedbackEl) {
          updateFeedback(
            feedbackEl,
            summaryMessage || 'Please fill in the required fields before continuing.',
            'error',
          );
        }
        return isValid;
      }

      function displayInlineError(target, baseMessage, error) {
        const details = error && error.message ? ` Details: ${error.message}` : '';
        const message = `⚠️ ${baseMessage}.${details ? ` ${details}` : ''}`.trim();
        const el = resolveElement(target);
        if (!el) {
          return;
        }
        if (el.tagName && el.tagName.toLowerCase() === 'pre') {
          setPreContent(el, message);
          return;
        }
        updateFeedback(el, message, 'error');
      }

      function performActionWithFeedback(button, {
        loadingText = 'Loading…',
        preId,
        feedbackEl,
        errorMessage,
        action,
      }) {
        if (!button) {
          return async () => {};
        }
        return async (...args) => {
          if (button.disabled) {
            return null;
          }
          const resolvedFeedbackEl = resolveElement(feedbackEl);
          const originalHtml = button.innerHTML;
          const originalAriaBusy = button.getAttribute('aria-busy');
          button.disabled = true;
          button.classList.add('cursor-not-allowed', 'opacity-70', 'animate-pulse');
          button.setAttribute('aria-busy', 'true');
          button.innerHTML = `<span class="flex items-center justify-center gap-2"><span class="h-2.5 w-2.5 rounded-full border-2 border-current border-t-transparent animate-spin"></span>${loadingText}</span>`;
          try {
            return await action(...args);
          } catch (error) {
            console.error(errorMessage, error);
            if (preId) {
              displayInlineError(preId, errorMessage, error);
            }
            if (resolvedFeedbackEl) {
              displayInlineError(resolvedFeedbackEl, errorMessage, error);
            }
            return null;
          } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
            button.classList.remove('cursor-not-allowed', 'opacity-70', 'animate-pulse');
            if (originalAriaBusy !== null) {
              button.setAttribute('aria-busy', originalAriaBusy);
            } else {
              button.removeAttribute('aria-busy');
            }
          }
        };
      }

      function ensureOkResponse(response) {
        if (!response || !response.ok) {
          throw new Error(`Server responded with status ${response ? response.status : 'unknown'}`);
        }
      }

      window.setPreContent = setPreContent;
      window.isPlaceholder = isPlaceholder;
      window.displayInlineError = displayInlineError;
      window.performActionWithFeedback = performActionWithFeedback;
      window.ensureOkResponse = ensureOkResponse;
      window.updateFeedback = updateFeedback;
      window.clearFeedback = clearFeedback;
      window.validateRequiredFields = validateRequiredFields;
      window.attachFieldValidation = attachFieldValidation;
      window.setFieldValidity = setFieldValidity;
    })();
  </script>
  <script src="{{ static_url(request, 'notifications.js') }}"></script>
  <style>
    .nav-dropdown-menu {
      pointer-events: none;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      z-index: 60;
    }
    [data-dropdown].open .nav-dropdown-menu,
    [data-dropdown][data-open="true"] .nav-dropdown-menu {
      pointer-events: auto;
    }
    [data-dropdown][data-open="true"] .nav-dropdown-menu {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="px-4 pb-4 pt-0">
  {% set current_path = request.url.path %}
  {% macro nav_link(href, label) %}
    {% set is_home = href == '/' %}
    {% set is_active = (is_home and current_path == '/') or (not is_home and current_path.startswith(href)) %}
    <a
      href="{{ href }}"
      class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium transition {{ 'bg-white text-gray-900 shadow' if is_active else 'text-white hover:bg-white/10' }}"
    >
      {{ label }}
    </a>
  {% endmacro %}

  <nav class="sticky top-0 relative mb-4 rounded-3xl border border-gray-900/20 bg-gray-900/80 px-4 py-3 text-white shadow-lg z-50">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <a
        href="/"
        class="flex items-center gap-3 text-sm font-semibold uppercase tracking-wide text-white/70"
        aria-label="Mindloom home"
      >
        <img
          src="{{ static_url(request, 'logo.png') }}"
          alt="Mindloom logo"
          class="h-10 w-auto rounded-full bg-white/10 p-1 shadow-lg"
        />
        <span class="sr-only">Mindloom</span>
      </a>
      <button
        id="navMenuToggle"
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-white/30 bg-white/10 px-3 py-1 text-sm font-medium text-white hover:bg-white/20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white lg:hidden"
        aria-controls="primaryNavGroup"
        aria-expanded="false"
      >
        Menu
        <span aria-hidden="true">☰</span>
      </button>
      <div
        id="primaryNavGroup"
        class="absolute left-3 right-3 top-full z-40 mt-2 hidden flex-col gap-3 rounded-3xl border border-white/20 bg-gray-900/90 p-4 shadow-lg lg:static lg:mt-0 lg:right-auto lg:left-auto lg:flex lg:flex-row lg:flex-wrap lg:items-center lg:w-auto lg:flex-1 lg:justify-end lg:border-0 lg:bg-transparent lg:p-0 lg:shadow-none"
      >
      <span class="sr-only">Primary navigation</span>
      <div class="flex flex-col gap-3 lg:flex-row lg:flex-wrap lg:items-center">
        <div class="relative" data-dropdown data-open="false">
          <button
            type="button"
            class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-sm font-medium text-white hover:bg-white/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
          >
            Tasks
            <span aria-hidden="true">▾</span>
          </button>
          <div
            class="nav-dropdown-menu invisible absolute left-0 top-full mt-1 rounded-2xl border border-white/20 bg-gray-900/90 p-2 opacity-0 shadow-lg transition"
          >
            <a href="/" class="block rounded-xl px-3 py-1 text-sm {{ 'bg-white text-gray-900' if current_path == '/' else 'text-white hover:bg-white/10' }}">
              Today's Tasks
            </a>
            <a href="/manage-tasks" class="mt-1 block rounded-xl px-3 py-1 text-sm {{ 'bg-white text-gray-900' if current_path.startswith('/manage-tasks') else 'text-white hover:bg-white/10' }}">
              Manage Tasks
            </a>
          </div>
        </div>
        <li class="list-none">{{ nav_link('/projects-page', 'Projects') }}</li>
        <div class="relative" data-dropdown data-open="false">
          <button
            type="button"
            class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-sm font-medium text-white hover:bg-white/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
          >
            Insights
            <span aria-hidden="true">▾</span>
          </button>
          <div
            class="nav-dropdown-menu invisible absolute left-0 top-full mt-1 w-40 rounded-2xl border border-white/20 bg-gray-900/90 p-2 opacity-0 shadow-lg transition"
          >
            <a href="/energy-trends" class="block rounded-xl px-3 py-1 text-sm {{ 'bg-white text-gray-900' if current_path.startswith('/energy-trends') else 'text-white hover:bg-white/10' }}">
              Energy Trends
            </a>
            <a href="/task-trends" class="mt-1 block rounded-xl px-3 py-1 text-sm {{ 'bg-white text-gray-900' if current_path.startswith('/task-trends') else 'text-white hover:bg-white/10' }}">
              Task Trends
            </a>
          </div>
        </div>
        <li class="list-none">{{ nav_link('/calendar', 'Calendar') }}</li>
        <li class="list-none">{{ nav_link('/reminders', 'Reminders') }}</li>
      </div>
    </div>
  </nav>
  <div class="mb-6">
    {% block nav_breadcrumbs %}{% endblock %}
  </div>
  {% block content %}{% endblock %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-dropdown]').forEach((container) => {
        const menu = container.querySelector('.nav-dropdown-menu');
        if (!menu) {
          return;
        }
        const show = () => container.setAttribute('data-open', 'true');
        const hide = () => container.setAttribute('data-open', 'false');
        let hideTimer;
        const cancelHide = () => {
          if (hideTimer) {
            clearTimeout(hideTimer);
            hideTimer = null;
          }
        };
        container.addEventListener('mouseenter', () => {
          cancelHide();
          show();
        });
        container.addEventListener('mouseleave', () => {
          cancelHide();
          hideTimer = window.setTimeout(hide, 150);
        });
        menu.addEventListener('mouseenter', () => {
          cancelHide();
        });
        menu.addEventListener('mouseleave', () => {
          hideTimer = window.setTimeout(hide, 150);
        });
      });
      const navToggle = document.getElementById('navMenuToggle');
      const primaryNavGroup = document.getElementById('primaryNavGroup');
      if (navToggle && primaryNavGroup) {
        navToggle.addEventListener('click', () => {
          const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
          navToggle.setAttribute('aria-expanded', String(!isExpanded));
          primaryNavGroup.classList.toggle('hidden');
        });
      }
    });
  </script>
  {% include "partials/new_task_modal.html" %}
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swPath = '{{ static_url(request, "sw.js") }}';
        navigator.serviceWorker
          .register(swPath)
          .then((registration) => {
            console.info('Registered Mindloom service worker', registration.scope);
          })
          .catch((error) => {
            console.warn('Mindloom service worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
