{% extends "base.html" %}
{% block title %}Mindloom{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-6 pt-6 pb-24">
    <section
      class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold">Pick my next task</h1>
        <p class="text-lg text-indigo-100">
          Quickly focus on what matters most. Choose your planning focus and let Mindloom surface the next best step.
        </p>
      </div>
      <div class="space-y-5">
        <div class="grid gap-4 md:grid-cols-3">
          <div class="flex flex-col gap-1">
            <label for="plannerMode" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Focus</label>
            <select id="plannerMode"
              class="w-full rounded-lg border-0 bg-white/10 text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
              <option value="next_task" selected>Next task</option>
              <option value="plan">Daily plan</option>
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label for="energy" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Energy</label>
            <select id="energy"
              class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
              <option value="1" {% if energy_summary.energy == 1 %}selected{% endif %}>ü™´ Drained</option>
              <option value="2" {% if energy_summary.energy == 2 %}selected{% endif %}>üò¥ Low</option>
              <option value="3" {% if energy_summary.energy == 3 %}selected{% endif %}>üôÇ OK</option>
              <option value="4" {% if energy_summary.energy == 4 %}selected{% endif %}>‚ö° Energized</option>
              <option value="5" {% if energy_summary.energy == 5 %}selected{% endif %}>üí• Turbo</option>
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label for="mood" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Mood</label>
            <select id="mood"
              class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
              <option value="Sad" {% if energy_summary.mood == 'Sad' %}selected{% endif %}>üòî Sad</option>
              <option value="Meh" {% if energy_summary.mood == 'Meh' %}selected{% endif %}>üòê Meh</option>
              <option value="Okay" {% if energy_summary.mood == 'Okay' %}selected{% endif %}>üòä Okay</option>
              <option value="Calm" {% if energy_summary.mood == 'Calm' %}selected{% endif %}>üòå Calm</option>
              <option value="Joyful" {% if energy_summary.mood == 'Joyful' %}selected{% endif %}>üòç Joyful</option>
            </select>
          </div>
        </div>
        <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <button id="focusAskBtn"
            class="w-full md:w-auto inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-6 py-3 text-lg font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200">
            Ask Mindloom
          </button>
          <details class="rounded-2xl border border-white/30 bg-white/10 p-4 text-sm text-indigo-100">
            <summary class="flex cursor-pointer items-center justify-between font-semibold text-indigo-50 transition hover:text-white">
              Advanced filters
              <span class="text-xs text-indigo-200">Project ¬∑ Area</span>
            </summary>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="projectFilter" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Project</label>
                <select id="projectFilter"
                  class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
                  <option value="">Any project</option>
                  {% for project in project_options %}
                  <option value="{{ project }}">{{ project }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="areaFilter" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Area</label>
                <select id="areaFilter"
                  class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
                  <option value="">Any area</option>
                  {% for area in area_options %}
                  <option value="{{ area }}">{{ area }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </details>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap items-center gap-3 text-xs text-indigo-100">
        <button
          id="momentumSnoozeBtn"
          type="button"
          class="inline-flex items-center gap-1 rounded-full border border-white/50 bg-white/10 px-4 py-2 font-semibold transition hover:border-white hover:bg-white/20"
        >
          Remind me later
        </button>
        <label class="inline-flex items-center gap-2 font-semibold uppercase tracking-wide text-indigo-100">
          <input id="stopForNowToggle" type="checkbox" class="h-4 w-4 rounded border-white/50 bg-black/60 text-white focus:ring-2 focus:ring-amber-300">
          Stop for now
        </label>
        <span class="text-indigo-200">Momentum nudges wait for the next request.</span>
      </div>
      <pre id="askResult"
        class="bg-indigo-900/40 border border-white/20 rounded-2xl p-4 text-sm font-mono whitespace-pre-wrap overflow-auto min-h-48 text-indigo-200 data-placeholder hidden"
        data-placeholder-class="text-indigo-200"
        data-active-class="text-white"
        data-reveal-on-content="true"
        aria-label="Results will appear here‚Ä¶"></pre>
    </section>

    <section class="space-y-3" aria-live="polite">
      <div id="activeTaskCard" class="hidden space-y-3 rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Active task</p>
            <h3 id="activeTaskTitle" class="text-lg font-semibold text-slate-900"></h3>
            <p id="activeTaskMeta" class="text-xs text-slate-500"></p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              data-active-task-action="done"
              class="rounded-full border border-emerald-200 bg-emerald-50 px-4 py-2 text-xs font-semibold text-emerald-800 transition hover:bg-emerald-100"
            >
              Done
            </button>
            <button
              type="button"
              data-active-task-action="still-going"
              class="rounded-full border border-amber-200 bg-amber-50 px-4 py-2 text-xs font-semibold text-amber-700 transition hover:bg-amber-100"
            >
              Still going
            </button>
            <button
              type="button"
              data-active-task-action="switch"
              class="rounded-full border border-indigo-200 bg-indigo-50 px-4 py-2 text-xs font-semibold text-indigo-700 transition hover:bg-indigo-100"
            >
              Switch task
            </button>
            <button
              type="button"
              data-active-task-action="stop"
              class="rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
            >
              Stop
            </button>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-xs text-slate-500">
          <p id="activeTaskCheckinHint" class="text-slate-600"></p>
          <button
            type="button"
            data-snooze-checkin
            class="font-semibold text-indigo-600 transition hover:text-indigo-500"
          >
            Snooze today
          </button>
        </div>
      </div>
      <div
        id="reminderToast"
        class="hidden rounded-3xl border border-indigo-200 bg-indigo-50/80 p-4 text-sm text-indigo-900 shadow-sm"
        aria-live="assertive"
      >
        <p id="reminderToastMessage" class="font-semibold"></p>
        <div id="reminderToastActions" class="mt-3 flex flex-wrap gap-2"></div>
      </div>
    </section>

    <section class="space-y-6">
      <div class="rounded-2xl border border-gray-100 bg-white/80 p-4 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <p class="text-xs text-slate-500">
            Capture a task without losing your place.
          </p>
          <button
            type="button"
            data-open-new-task-modal
            data-new-task-default-due="{{ today_iso }}"
            class="inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400"
          >
            New Task
          </button>
        </div>
      </div>
      <div class="space-y-6 rounded-3xl border border-slate-200 bg-white/90 p-6 shadow-sm">
        <div class="space-y-4 rounded-3xl bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 p-6 text-white">
          <div class="space-y-1">
            <p class="text-xs font-semibold uppercase tracking-wide">Due {{ today.strftime("%A, %B %d, %Y") }}</p>
            <h2 class="text-2xl font-bold tracking-tight">Today's Tasks</h2>
            <p class="text-sm text-indigo-100 max-w-3xl">
              Prioritized by your current energy and mood so you tackle the hardest achievable work first.
            </p>
          </div>
          <div class="rounded-2xl border border-white/30 bg-white/10 p-5 backdrop-blur">
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 text-2xl text-emerald-900">
                {{ energy_summary.emoji }}
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-white">
                  Energy {{ energy_summary.energy }} ¬∑ {{ energy_summary.mood }}
                </p>
                <p class="text-xs text-indigo-100">
                  Available capacity {{ energy_summary.available_display | round(1) }} / 5
                </p>
              </div>
            </div>
            <p class="mt-4 text-xs text-indigo-100">{{ energy_summary.message }}</p>
          </div>
        </div>

        <form method="post" action="/daily-tasks" class="space-y-6" id="dailyTasksForm">
          <input type="hidden" name="today" id="dailyTasksToday" value="{{ today_iso }}">
          <section class="space-y-3 rounded-3xl border border-slate-200 bg-slate-50/80 p-6">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="text-lg font-semibold text-slate-900">Ready for today</h3>
                <p class="text-xs text-slate-500">
                  Sorted hardest first while keeping you within your current energy limit.
                </p>
              </div>
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                {{ achievable_tasks | length }} tasks
              </span>
            </div>
            {% if achievable_tasks %}
            <ul class="space-y-3">
              {% for task in achievable_tasks %}
              <li class="flex flex-col gap-3 rounded-2xl p-4 {% if task.is_overdue %}border border-rose-300 bg-rose-50/70{% else %}border border-slate-200 bg-slate-50/80{% endif %}">
                <label class="flex w-full cursor-pointer items-start gap-3">
                  <input type="checkbox" name="task_id" value="{{ task.id }}" class="mt-1 h-4 w-4 shrink-0 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                  <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-3">
                      <p class="text-base font-semibold text-slate-900">{{ task.title }}</p>
                      {% if task.is_overdue %}
                      <span class="rounded-full border border-rose-200 bg-rose-100 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide text-rose-600">
                        Overdue
                      </span>
                      {% endif %}
                      <span class="text-xs font-mono uppercase text-slate-500">
                        Energy {{ task.energy_cost }}
                      </span>
                    </div>
                    <div class="mt-1 flex flex-wrap gap-2 text-xs text-slate-500">
                      {% if task.project %}
                      <span>Project {{ task.project }}</span>
                      {% endif %}
                      {% if task.area %}
                      <span>Area {{ task.area }}</span>
                      {% endif %}
                      <span>
                        Leaves {{ task.capacity_gap | round(1) }} energy
                      </span>
                    {% if task.executive_penalty and task.executive_penalty > 0 %}
                    <span class="text-rose-500">
                      Exec penalty {{ task.executive_penalty }}
                    </span>
                    {% endif %}
                    </div>
                    {% if task.reason %}
                    <p class="mt-2 text-xs text-slate-600">{{ task.reason }}</p>
                    {% endif %}
                  </div>
                </label>
                <div class="flex flex-wrap items-center gap-3">
                  <button
                    type="button"
                    data-start-active-task
                    data-task-id="{{ task.id }}"
                    data-task-title="{{ task.title | e }}"
                    data-task-project="{{ task.project | default('') | e }}"
                    data-task-area="{{ task.area | default('') | e }}"
                    class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-400 hover:bg-slate-50"
                  >
                    Start working
                  </button>
                  <span class="text-xs text-slate-400">Track progress without leaving the page.</span>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-sm text-slate-500">
              Nothing due today fits within your current energy level. Take a breather or adjust your energy log.
            </p>
            {% endif %}
          </section>

          <section class="space-y-3 rounded-3xl border border-rose-200 bg-rose-50/80 p-6">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="text-lg font-semibold text-slate-900">Exceeds your limit</h3>
                <p class="text-xs text-slate-500">
                  Too costly for now‚Äîsaved here for when you feel ready.
                </p>
              </div>
              <span class="text-xs font-semibold uppercase tracking-wide text-rose-500">
                {{ over_limit_tasks | length }} blocked
              </span>
            </div>
            {% if over_limit_tasks %}
            <ul class="space-y-3">
              {% for task in over_limit_tasks %}
              <li class="flex flex-col gap-3 rounded-2xl border p-4 {% if task.is_overdue %}border-rose-400 bg-rose-50/80{% else %}border-rose-200 bg-white{% endif %}">
                <label class="flex w-full cursor-pointer items-start gap-3">
                  <input type="checkbox" name="task_id" value="{{ task.id }}" class="mt-1 h-4 w-4 shrink-0 rounded border-rose-300 text-rose-500 focus:ring-rose-500">
                  <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-3">
                      <p class="text-base font-semibold text-slate-900">{{ task.title }}</p>
                      {% if task.is_overdue %}
                      <span class="rounded-full border border-rose-200 bg-rose-100 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-wide text-rose-600">
                        Overdue
                      </span>
                      {% endif %}
                      <span class="text-xs font-mono uppercase text-slate-500">
                        Energy {{ task.energy_cost }}
                      </span>
                    </div>
                    <div class="mt-1 flex flex-wrap gap-2 text-xs text-slate-500">
                      {% if task.project %}
                      <span>Project {{ task.project }}</span>
                      {% endif %}
                      {% if task.area %}
                      <span>Area {{ task.area }}</span>
                      {% endif %}
                      <span>
                        Exceeds limit by {{ (-task.capacity_gap) | round(1) }}
                      </span>
                      {% if task.executive_penalty and task.executive_penalty > 0 %}
                      <span class="text-rose-500">
                        Exec penalty {{ task.executive_penalty }}
                      </span>
                      {% endif %}
                    </div>
                    {% if task.reason %}
                    <p class="mt-2 text-xs text-slate-600">{{ task.reason }}</p>
                    {% endif %}
                  </div>
                </label>
                <div class="flex flex-wrap items-center gap-3">
                  <button
                    type="button"
                    data-start-active-task
                    data-task-id="{{ task.id }}"
                    data-task-title="{{ task.title | e }}"
                    data-task-project="{{ task.project | default('') | e }}"
                    data-task-area="{{ task.area | default('') | e }}"
                    class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-400 hover:bg-slate-50"
                  >
                    Start working
                  </button>
                  <span class="text-xs text-slate-400">Log this one when you‚Äôre ready.</span>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-sm text-rose-600">
              All due tasks fall within your current capacity. Keep the momentum going.
            </p>
            {% endif %}
          </section>

          <div class="flex justify-end">
            <button type="submit" class="flex items-center justify-center rounded-full bg-emerald-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
              Mark Complete
            </button>
          </div>
          <div class="pointer-events-auto md:hidden">
            <div class="fixed inset-x-4 bottom-4 z-40 flex justify-center">
              <button type="submit" class="w-full max-w-md rounded-full bg-emerald-600 px-6 py-3 text-sm font-semibold text-white shadow-lg transition hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                Mark Complete
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </div>

<script>
const plannerModeSelect = document.getElementById('plannerMode');
const projectFilterSelect = document.getElementById('projectFilter');
const areaFilterSelect = document.getElementById('areaFilter');
const focusAskBtn = document.getElementById('focusAskBtn');

function parseIsoLocalDate(dateString) {
  if (typeof dateString !== 'string') {
    return null;
  }

  const parts = dateString.split('-').map((value) => Number(value));
  if (parts.length !== 3 || parts.some((value) => Number.isNaN(value))) {
    return null;
  }

  const [year, month, day] = parts;
  return new Date(year, month - 1, day);
}

function formatDueDetail(dateString) {
  if (!dateString) {
    return null;
  }

  let dueDate = parseIsoLocalDate(dateString);
  if (!dueDate) {
    dueDate = new Date(dateString);
  }
  if (Number.isNaN(dueDate.getTime())) {
    return `Due: ${dateString}`;
  }

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.round((dueDate.getTime() - today.getTime()) / msPerDay);

  let relation = '';
  if (diffDays === 0) {
    relation = ' (today)';
  } else if (diffDays === 1) {
    relation = ' (tomorrow)';
  } else if (diffDays > 1) {
    relation = ` (in ${diffDays} days)`;
  } else if (diffDays === -1) {
    relation = ' (1 day overdue)';
  } else {
    relation = ` (${Math.abs(diffDays)} days overdue)`;
  }

  const formatted = dueDate.toLocaleDateString(undefined, {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
  });

  return `Due: ${formatted}${relation}`;
}

function describeEnergyCost(cost) {
  if (typeof cost !== 'number') {
    return null;
  }

  const labels = {
    1: 'Very low',
    2: 'Low',
    3: 'Moderate',
    4: 'High',
    5: 'Very high'
  };

  return `Energy: ${cost} (${labels[cost] || 'Custom'})`;
}

function normalizeList(value) {
  if (!value) {
    return null;
  }

  if (Array.isArray(value)) {
    return value.filter(Boolean).join(', ');
  }

  if (typeof value === 'string') {
    return value;
  }

  return null;
}

function formatScoreBreakdown(reasoning) {
  if (!reasoning || typeof reasoning !== 'object') {
    return [];
  }

  const breakdown = [];
  const hasDueKey = Object.prototype.hasOwnProperty.call(reasoning, 'due_date');

  if (hasDueKey) {
    const dueValue = reasoning.due_date;
    if (dueValue) {
      const formatted = formatDueDetail(dueValue);
      if (formatted) {
        breakdown.push(`‚Ä¢ ${formatted.replace(/^Due: /, 'Due date: ')}`);
      } else {
        breakdown.push(`‚Ä¢ Due date: ${dueValue}`);
      }
    } else {
      breakdown.push('‚Ä¢ Due date: None provided');
    }
  }

  const numericFields = [
    ['energy_penalty', 'Energy penalty'],
    ['executive_penalty', 'Executive penalty'],
    ['total_score', 'Total score']
  ];

  numericFields.forEach(([key, label]) => {
    const value = reasoning[key];
    if (typeof value === 'number' && Number.isFinite(value)) {
      breakdown.push(`‚Ä¢ ${label}: ${value}`);
    }
  });

  return breakdown;
}

function formatTaskSummary(task, reasoning) {
  if (!task || typeof task !== 'object') {
    if (typeof task === 'string') {
      return task;
    }
    return JSON.stringify(task, null, 2);
  }

  const lines = [];
  const title = task.title || 'Next task';
  lines.push(`‚≠ê ${title}`);

  const description = [task.summary, task.description, task.notes]
    .map((value) => (typeof value === 'string' ? value.trim() : ''))
    .find((value) => value);
  if (description) {
    lines.push('', description);
  }

  const details = [];
  const dueDetail = formatDueDetail(task.next_due || task.due);
  if (dueDetail) {
    details.push(dueDetail);
  }

  if (task.project) {
    details.push(`Project: ${task.project}`);
  }

  if (task.area) {
    details.push(`Area: ${task.area}`);
  }

  if (task.context) {
    details.push(`Context: ${task.context}`);
  }

  if (task.location) {
    details.push(`Location: ${task.location}`);
  }

  if (task.priority) {
    details.push(`Priority: ${task.priority}`);
  }

  if (task.effort) {
    details.push(`Effort: ${task.effort}`);
  }

  const energyDetail = describeEnergyCost(task.energy_cost ?? task.energy);
  if (energyDetail) {
    details.push(energyDetail);
  }

  if (task.duration) {
    details.push(`Duration: ${task.duration}`);
  }

  if (task.executive_trigger) {
    details.push(`Executive trigger: ${task.executive_trigger}`);
  }

  if (task.recurrence) {
    details.push(`Recurs: ${task.recurrence}`);
  }

  if (task.last_completed) {
    details.push(`Last completed: ${task.last_completed}`);
  }

  const tags = normalizeList(task.tags);
  if (tags) {
    details.push(`Tags: ${tags}`);
  }

  if (task.url) {
    details.push(`Link: ${task.url}`);
  }

  if (task.id) {
    details.push(`Task ID: ${task.id}`);
  }

  if (details.length) {
    lines.push('', ...details.map((detail) => `‚Ä¢ ${detail}`));
  }

  const breakdownLines = formatScoreBreakdown(reasoning);
  if (breakdownLines.length) {
    lines.push('', 'Score breakdown:', ...breakdownLines);
  }

  return lines.join('\n');
}

async function requestPlan(mode) {
  const effectiveMode = mode || 'next_task';
  const energyEl = document.getElementById('energy');
  const moodEl = document.getElementById('mood');
  const askResultEl = document.getElementById('askResult');

  const requestPayload = {};
  if (effectiveMode === 'next_task') {
    const energyValue = energyEl ? energyEl.value : '';
    const moodValue = moodEl ? moodEl.value : '';

    if (!energyValue || !moodValue) {
      const message = '‚ö†Ô∏è Please select your energy and mood before asking for the next task.';
      setPreContent(askResultEl, message);
      return;
    }

    const parsedEnergy = Number.parseInt(energyValue, 10);
    if (Number.isNaN(parsedEnergy)) {
      const message = '‚ö†Ô∏è Energy must be a valid number to request the next task.';
      setPreContent(askResultEl, message);
      return;
    }

    requestPayload.energy = parsedEnergy;
    requestPayload.mood = moodValue;
  }

  const projectValue = projectFilterSelect ? projectFilterSelect.value : '';
  if (projectValue) {
    requestPayload.project = projectValue;
  }

  const areaValue = areaFilterSelect ? areaFilterSelect.value : '';
  if (areaValue) {
    requestPayload.area = areaValue;
  }

  const fetchOptions = { method: 'POST' };
  if (Object.keys(requestPayload).length > 0) {
    fetchOptions.headers = { 'Content-Type': 'application/json' };
    fetchOptions.body = JSON.stringify(requestPayload);
  }

  const res = await fetch(`/plan?mode=${encodeURIComponent(effectiveMode)}`, fetchOptions);
  ensureOkResponse(res);
  const data = await res.json();
  if (effectiveMode === 'next_task') {
    if (data.next_task) {
      const summary = formatTaskSummary(data.next_task, data.reasoning);
      setPreContent(askResultEl, summary || JSON.stringify(data.next_task, null, 2));
    } else if (data.plan) {
      setPreContent(askResultEl, data.plan);
    } else {
      setPreContent(askResultEl, JSON.stringify(data, null, 2));
    }
    if (typeof window !== 'undefined' && typeof window.dispatchEvent === 'function') {
      window.dispatchEvent(
        new CustomEvent('mindloom-next-task-request', {
          detail: { mode: effectiveMode, nextTaskAvailable: Boolean(data.next_task) },
        }),
      );
    }
    return data;
  }
  if (data.plan) {
    setPreContent(askResultEl, data.plan);
  } else {
    setPreContent(askResultEl, JSON.stringify(data, null, 2));
  }
  window.location.href = '/' + (window.location.search || '');
  return data;
}

if (focusAskBtn) {
  focusAskBtn.onclick = performActionWithFeedback(focusAskBtn, {
    loadingText: 'Asking‚Ä¶',
    preId: 'askResult',
    errorMessage: 'Unable to load plan',
    action: async () => {
      const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
      await requestPlan(mode);
    }
  });
}

async function prefillEnergyMoodFromLatestEntry() {
  try {
    const res = await fetch('/energy');
    ensureOkResponse(res);
    const data = await res.json();
    const latest = Array.isArray(data) ? data[data.length - 1] : null;
    if (!latest) {
      return;
    }
    const energyEl = document.getElementById('energy');
    if (energyEl && typeof latest.energy !== 'undefined') {
      energyEl.value = String(latest.energy);
    }
    const moodEl = document.getElementById('mood');
    if (moodEl && typeof latest.mood === 'string') {
      moodEl.value = latest.mood;
    }
  } catch (error) {
    console.error('Unable to sync energy/mood from latest entry', error);
  }
}

function setDailyTasksTodayInput() {
  const todayInput = document.getElementById('dailyTasksToday');
  if (!todayInput) {
    return;
  }
  const now = new Date();
  const tzOffsetMs = now.getTimezoneOffset() * 60_000;
  const localDate = new Date(now.getTime() - tzOffsetMs).toISOString().slice(0, 10);
  todayInput.value = localDate;
}

const dailyTasksFormElement = document.getElementById('dailyTasksForm');
if (dailyTasksFormElement) {
  dailyTasksFormElement.addEventListener('submit', () => {
    const selectedCount = dailyTasksFormElement.querySelectorAll('input[name="task_id"]:checked')
      .length;
    if (typeof window !== 'undefined' && typeof window.dispatchEvent === 'function') {
      window.dispatchEvent(
        new CustomEvent('mindloom-task-completed', { detail: { count: selectedCount } }),
      );
    }
  });
}

prefillEnergyMoodFromLatestEntry();
setDailyTasksTodayInput();
</script>

{% endblock %}
