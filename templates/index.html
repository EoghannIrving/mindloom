{% extends "base.html" %}
{% block title %}Mindloom{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-6">
    <section
      class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold">Pick my next task</h1>
        <p class="text-lg text-indigo-100">
          Quickly focus on what matters most. Choose your planning focus and let Mindloom surface the next best step.
        </p>
      </div>
      <div class="flex flex-col gap-4 lg:flex-row lg:flex-wrap lg:items-end">
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="plannerMode" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Focus</label>
          <select id="plannerMode"
            class="w-full rounded-lg border-0 bg-white/10 text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="next_task" selected>Next task</option>
            <option value="plan">Daily plan</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="energy" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Energy</label>
          <select id="energy"
            class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="1">ü™´ Drained</option>
            <option value="2">üò¥ Low</option>
            <option value="3">üôÇ OK</option>
            <option value="4">‚ö° Energized</option>
            <option value="5">üí• Turbo</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="mood" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Mood</label>
          <select id="mood"
            class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="Sad">üòî Sad</option>
            <option value="Meh">üòê Meh</option>
            <option value="Okay">üòä Okay</option>
            <option value="Calm">üòå Calm</option>
            <option value="Joyful">üòç Joyful</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="projectFilter" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Project</label>
          <select id="projectFilter"
            class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="">Any project</option>
            {% for project in project_options %}
            <option value="{{ project }}">{{ project }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="areaFilter" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Area</label>
          <select id="areaFilter"
            class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="">Any area</option>
            {% for area in area_options %}
            <option value="{{ area }}">{{ area }}</option>
            {% endfor %}
          </select>
        </div>
        <button id="focusAskBtn"
          class="w-full sm:w-auto lg:self-end inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-6 py-3 text-lg font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200">
          Ask Mindloom
        </button>
      </div>
      <pre id="askResult"
        class="bg-indigo-900/40 border border-white/20 rounded-2xl p-4 text-sm font-mono whitespace-pre-wrap overflow-auto min-h-48 text-indigo-200 data-placeholder"
        data-placeholder-class="text-indigo-200" data-active-class="text-white">Results will appear here‚Ä¶</pre>
    </section>

    <div class="space-y-4">
      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Prompts &amp; Templates</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">‚ñº</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-3 sm:flex-row">
            <select id="promptSelect"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              {% for p in prompt_files %}
              <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <textarea id="promptVars" placeholder='{"energy":5}'
              class="flex-1 min-h-[48px] rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"></textarea>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="renderPrompt"
              class="rounded-lg border border-indigo-200 bg-indigo-50 px-4 py-2 text-sm font-medium text-indigo-700 transition hover:bg-indigo-100">Render</button>
            <button id="askBtn"
              class="rounded-lg border border-purple-200 bg-purple-50 px-4 py-2 text-sm font-medium text-purple-700 transition hover:bg-purple-100">Send to Mindloom</button>
          </div>
          <pre id="promptResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here‚Ä¶</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Record Energy</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">‚ñº</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <p class="text-sm text-gray-500">Update your energy, mood, and time blocks above, then record a snapshot for your log.</p>
          <div>
            <button id="recordBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Record</button>
          </div>
          <pre id="recordResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here‚Ä¶</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Data</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">‚ñº</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="loadProjects"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Projects</button>
            <button id="loadEnergy"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Energy</button>
          </div>
          <pre id="projects"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here‚Ä¶</pre>
          <pre id="energyData"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here‚Ä¶</pre>
        </div>
      </details>
    </div>
  </div>


<script>
const recordBtn = document.getElementById('recordBtn');
if (recordBtn) {
  recordBtn.onclick = performActionWithFeedback(recordBtn, {
    loadingText: 'Recording‚Ä¶',
    preId: 'recordResult',
    errorMessage: 'Unable to record energy',
    action: async () => {
      const payload = {
        energy: parseInt(document.getElementById('energy').value),
        mood: document.getElementById('mood').value,
      };
      const res = await fetch('/energy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('recordResult', JSON.stringify(data, null, 2));
    }
  });
}

const loadProjectsBtn = document.getElementById('loadProjects');
if (loadProjectsBtn) {
  loadProjectsBtn.onclick = performActionWithFeedback(loadProjectsBtn, {
    loadingText: 'Loading‚Ä¶',
    preId: 'projects',
    errorMessage: 'Unable to load projects',
    action: async () => {
      const res = await fetch('/projects');
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('projects', JSON.stringify(data, null, 2));
    }
  });
}

const loadEnergyBtn = document.getElementById('loadEnergy');
if (loadEnergyBtn) {
  loadEnergyBtn.onclick = performActionWithFeedback(loadEnergyBtn, {
    loadingText: 'Loading‚Ä¶',
    preId: 'energyData',
    errorMessage: 'Unable to load energy data',
    action: async () => {
      const res = await fetch('/energy');
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('energyData', JSON.stringify(data, null, 2));
    }
  });
}

const plannerModeSelect = document.getElementById('plannerMode');
const projectFilterSelect = document.getElementById('projectFilter');
const areaFilterSelect = document.getElementById('areaFilter');
const focusAskBtn = document.getElementById('focusAskBtn');

function parseIsoLocalDate(dateString) {
  if (typeof dateString !== 'string') {
    return null;
  }

  const parts = dateString.split('-').map((value) => Number(value));
  if (parts.length !== 3 || parts.some((value) => Number.isNaN(value))) {
    return null;
  }

  const [year, month, day] = parts;
  return new Date(year, month - 1, day);
}

function formatDueDetail(dateString) {
  if (!dateString) {
    return null;
  }

  let dueDate = parseIsoLocalDate(dateString);
  if (!dueDate) {
    dueDate = new Date(dateString);
  }
  if (Number.isNaN(dueDate.getTime())) {
    return `Due: ${dateString}`;
  }

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.round((dueDate.getTime() - today.getTime()) / msPerDay);

  let relation = '';
  if (diffDays === 0) {
    relation = ' (today)';
  } else if (diffDays === 1) {
    relation = ' (tomorrow)';
  } else if (diffDays > 1) {
    relation = ` (in ${diffDays} days)`;
  } else if (diffDays === -1) {
    relation = ' (1 day overdue)';
  } else {
    relation = ` (${Math.abs(diffDays)} days overdue)`;
  }

  const formatted = dueDate.toLocaleDateString(undefined, {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
  });

  return `Due: ${formatted}${relation}`;
}

function describeEnergyCost(cost) {
  if (typeof cost !== 'number') {
    return null;
  }

  const labels = {
    1: 'Very low',
    2: 'Low',
    3: 'Moderate',
    4: 'High',
    5: 'Very high'
  };

  return `Energy: ${cost} (${labels[cost] || 'Custom'})`;
}

function normalizeList(value) {
  if (!value) {
    return null;
  }

  if (Array.isArray(value)) {
    return value.filter(Boolean).join(', ');
  }

  if (typeof value === 'string') {
    return value;
  }

  return null;
}

function formatScoreBreakdown(reasoning) {
  if (!reasoning || typeof reasoning !== 'object') {
    return [];
  }

  const breakdown = [];
  const hasDueKey = Object.prototype.hasOwnProperty.call(reasoning, 'due_date');

  if (hasDueKey) {
    const dueValue = reasoning.due_date;
    if (dueValue) {
      const formatted = formatDueDetail(dueValue);
      if (formatted) {
        breakdown.push(`‚Ä¢ ${formatted.replace(/^Due: /, 'Due date: ')}`);
      } else {
        breakdown.push(`‚Ä¢ Due date: ${dueValue}`);
      }
    } else {
      breakdown.push('‚Ä¢ Due date: None provided');
    }
  }

  const numericFields = [
    ['energy_penalty', 'Energy penalty'],
    ['executive_penalty', 'Executive penalty'],
    ['total_score', 'Total score']
  ];

  numericFields.forEach(([key, label]) => {
    const value = reasoning[key];
    if (typeof value === 'number' && Number.isFinite(value)) {
      breakdown.push(`‚Ä¢ ${label}: ${value}`);
    }
  });

  return breakdown;
}

function formatTaskSummary(task, reasoning) {
  if (!task || typeof task !== 'object') {
    if (typeof task === 'string') {
      return task;
    }
    return JSON.stringify(task, null, 2);
  }

  const lines = [];
  const title = task.title || 'Next task';
  lines.push(`‚≠ê ${title}`);

  const description = [task.summary, task.description, task.notes]
    .map((value) => (typeof value === 'string' ? value.trim() : ''))
    .find((value) => value);
  if (description) {
    lines.push('', description);
  }

  const details = [];
  const dueDetail = formatDueDetail(task.next_due || task.due);
  if (dueDetail) {
    details.push(dueDetail);
  }

  if (task.project) {
    details.push(`Project: ${task.project}`);
  }

  if (task.area) {
    details.push(`Area: ${task.area}`);
  }

  if (task.context) {
    details.push(`Context: ${task.context}`);
  }

  if (task.location) {
    details.push(`Location: ${task.location}`);
  }

  if (task.priority) {
    details.push(`Priority: ${task.priority}`);
  }

  if (task.effort) {
    details.push(`Effort: ${task.effort}`);
  }

  const energyDetail = describeEnergyCost(task.energy_cost ?? task.energy);
  if (energyDetail) {
    details.push(energyDetail);
  }

  if (task.duration) {
    details.push(`Duration: ${task.duration}`);
  }

  if (task.executive_trigger) {
    details.push(`Executive trigger: ${task.executive_trigger}`);
  }

  if (task.recurrence) {
    details.push(`Recurs: ${task.recurrence}`);
  }

  if (task.last_completed) {
    details.push(`Last completed: ${task.last_completed}`);
  }

  const tags = normalizeList(task.tags);
  if (tags) {
    details.push(`Tags: ${tags}`);
  }

  if (task.url) {
    details.push(`Link: ${task.url}`);
  }

  if (task.id) {
    details.push(`Task ID: ${task.id}`);
  }

  if (details.length) {
    lines.push('', ...details.map((detail) => `‚Ä¢ ${detail}`));
  }

  const breakdownLines = formatScoreBreakdown(reasoning);
  if (breakdownLines.length) {
    lines.push('', 'Score breakdown:', ...breakdownLines);
  }

  return lines.join('\n');
}

async function requestPlan(mode) {
  const effectiveMode = mode || 'next_task';
  const energyEl = document.getElementById('energy');
  const moodEl = document.getElementById('mood');
  const askResultEl = document.getElementById('askResult');

  const requestPayload = {};
  if (effectiveMode === 'next_task') {
    const energyValue = energyEl ? energyEl.value : '';
    const moodValue = moodEl ? moodEl.value : '';

    if (!energyValue || !moodValue) {
      const message = '‚ö†Ô∏è Please select your energy and mood before asking for the next task.';
      setPreContent(askResultEl, message);
      return;
    }

    const parsedEnergy = Number.parseInt(energyValue, 10);
    if (Number.isNaN(parsedEnergy)) {
      const message = '‚ö†Ô∏è Energy must be a valid number to request the next task.';
      setPreContent(askResultEl, message);
      return;
    }

    requestPayload.energy = parsedEnergy;
    requestPayload.mood = moodValue;
  }

  const projectValue = projectFilterSelect ? projectFilterSelect.value : '';
  if (projectValue) {
    requestPayload.project = projectValue;
  }

  const areaValue = areaFilterSelect ? areaFilterSelect.value : '';
  if (areaValue) {
    requestPayload.area = areaValue;
  }

  const fetchOptions = { method: 'POST' };
  if (Object.keys(requestPayload).length > 0) {
    fetchOptions.headers = { 'Content-Type': 'application/json' };
    fetchOptions.body = JSON.stringify(requestPayload);
  }

  const res = await fetch(`/plan?mode=${encodeURIComponent(effectiveMode)}`, fetchOptions);
  ensureOkResponse(res);
  const data = await res.json();
  if (effectiveMode === 'next_task') {
    if (data.next_task) {
      const summary = formatTaskSummary(data.next_task, data.reasoning);
      setPreContent(askResultEl, summary || JSON.stringify(data.next_task, null, 2));
    } else if (data.plan) {
      setPreContent(askResultEl, data.plan);
    } else {
      setPreContent(askResultEl, JSON.stringify(data, null, 2));
    }
    return;
  }
  if (data.plan) {
    setPreContent(askResultEl, data.plan);
  } else {
    setPreContent(askResultEl, JSON.stringify(data, null, 2));
  }
  window.location.href = '/daily-tasks';
}

if (focusAskBtn) {
  focusAskBtn.onclick = performActionWithFeedback(focusAskBtn, {
    loadingText: 'Asking‚Ä¶',
    preId: 'askResult',
    errorMessage: 'Unable to load plan',
    action: async () => {
      const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
      await requestPlan(mode);
    }
  });
}

async function renderPromptAction() {
  const select = document.getElementById('promptSelect');
  const varsText = document.getElementById('promptVars').value || '{}';
  let variables = {};
  try {
    variables = JSON.parse(varsText);
  } catch {
    alert('Invalid JSON in variables');
    return;
  }
  const warnings = [];
  try {
    const tasksRes = await fetch('/tasks');
    ensureOkResponse(tasksRes);
    const tasksData = await tasksRes.json();
    if (!select.value.endsWith('morning_planner.txt')) {
      variables.tasks = tasksData;
    }
  } catch (e) {
    warnings.push(`‚ö†Ô∏è Unable to load tasks data. ${e.message || ''}`.trim());
  }
  try {
    const energyRes = await fetch('/energy');
    ensureOkResponse(energyRes);
    const energyData = await energyRes.json();
    const latest = energyData[energyData.length - 1];
    if (latest) {
      if (!('energy' in variables)) {
        variables.energy = latest.energy;
      }
      if (!('mood' in variables)) {
        variables.mood = latest.mood;
      }
    }
  } catch (e) {
    warnings.push(`‚ö†Ô∏è Unable to load energy data. ${e.message || ''}`.trim());
  }
  const payload = { template: select.value, variables };
  const res = await fetch('/render-prompt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  ensureOkResponse(res);
  const data = await res.json();
  const resultContent = data.result ? data.result : JSON.stringify(data, null, 2);
  if (warnings.length) {
    const combined = [...warnings, '', resultContent].join('\n');
    setPreContent('promptResult', combined.replace(/\n/g, String.fromCharCode(10)));
    return;
  }
  if (data.result) {
    setPreContent('promptResult', data.result);
  } else {
    setPreContent('promptResult', JSON.stringify(data, null, 2));
  }
}

const renderPromptBtn = document.getElementById('renderPrompt');
if (renderPromptBtn) {
  renderPromptBtn.onclick = performActionWithFeedback(renderPromptBtn, {
    loadingText: 'Rendering‚Ä¶',
    preId: 'promptResult',
    errorMessage: 'Unable to render prompt',
    action: renderPromptAction
  });
}

const promptSelect = document.getElementById('promptSelect');
if (promptSelect) {
  promptSelect.onchange = () => {
    if (promptSelect.value.endsWith('morning_planner.txt')) {
      renderPromptAction().catch((error) => {
        console.error('Unable to auto-render prompt', error);
        displayInlineError('promptResult', 'Unable to render prompt', error);
      });
    }
  };
}

const askBtn = document.getElementById('askBtn');
if (askBtn) {
  askBtn.onclick = performActionWithFeedback(askBtn, {
    loadingText: 'Sending‚Ä¶',
    preId: 'askResult',
    errorMessage: 'Unable to process request',
    action: async () => {
      const select = document.getElementById('promptSelect');
      if (select.value.endsWith('morning_planner.txt')) {
        const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
        await requestPlan(mode);
        return;
      }

      const promptResultEl = document.getElementById('promptResult');
      if (isPlaceholder(promptResultEl)) {
        alert('Render a prompt first');
        return;
      }
      const prompt = promptResultEl.textContent.trim();
      if (!prompt) {
        alert('Render a prompt first');
        return;
      }
      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      ensureOkResponse(res);
      const data = await res.json();
      if (data.response) {
        setPreContent('askResult', data.response);
      } else {
        setPreContent('askResult', JSON.stringify(data, null, 2));
      }
    }
  });
}

async function prefillEnergyMoodFromLatestEntry() {
  try {
    const res = await fetch('/energy');
    ensureOkResponse(res);
    const data = await res.json();
    const latest = Array.isArray(data) ? data[data.length - 1] : null;
    if (!latest) {
      return;
    }
    const energyEl = document.getElementById('energy');
    if (energyEl && typeof latest.energy !== 'undefined') {
      energyEl.value = String(latest.energy);
    }
    const moodEl = document.getElementById('mood');
    if (moodEl && typeof latest.mood === 'string') {
      moodEl.value = latest.mood;
    }
  } catch (error) {
    console.error('Unable to sync energy/mood from latest entry', error);
  }
}

prefillEnergyMoodFromLatestEntry();
</script>

{% endblock %}
