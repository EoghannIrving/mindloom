{% extends "base.html" %}
{% block title %}Mindloom{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-6">
    <section
      class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold">Pick my next task</h1>
        <p class="text-lg text-indigo-100">
          Quickly focus on what matters most. Choose your planning focus and let Mindloom surface the next best step.
        </p>
      </div>
      <div class="flex flex-col gap-4 lg:flex-row lg:flex-wrap lg:items-end">
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="plannerMode" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Focus</label>
          <select id="plannerMode"
            class="w-full rounded-lg border-0 bg-white/10 text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="next_task" selected>Next task</option>
            <option value="plan">Daily plan</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="energy" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Energy</label>
          <select id="energy"
            class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="1">🪫 Drained</option>
            <option value="2">😴 Low</option>
            <option value="3">🙂 OK</option>
            <option value="4">⚡ Energized</option>
            <option value="5">💥 Turbo</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="mood" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Mood</label>
          <select id="mood"
            class="w-full rounded-lg border-0 bg-white/10 text-white focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
            <option value="Sad">😔 Sad</option>
            <option value="Meh">😐 Meh</option>
            <option value="Okay">😊 Okay</option>
            <option value="Joyful">😍 Joyful</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 w-full sm:max-w-sm lg:flex-1">
          <label for="timeBlocks" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Time blocks free</label>
          <input id="timeBlocks" type="number" step="1" placeholder="Time blocks free"
            class="w-full rounded-lg border-0 bg-white/10 text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3" />
        </div>
        <button id="focusAskBtn"
          class="w-full sm:w-auto lg:self-end inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-6 py-3 text-lg font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200">
          Ask Mindloom
        </button>
      </div>
      <pre id="askResult"
        class="bg-indigo-900/40 border border-white/20 rounded-2xl p-4 text-sm font-mono whitespace-pre-wrap overflow-auto min-h-48 text-indigo-200 data-placeholder"
        data-placeholder-class="text-indigo-200" data-active-class="text-white">Results will appear here…</pre>
    </section>

    <div class="space-y-4">
      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Prompts &amp; Templates</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-3 sm:flex-row">
            <select id="promptSelect"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              {% for p in prompt_files %}
              <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <textarea id="promptVars" placeholder='{"energy":5}'
              class="flex-1 min-h-[48px] rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"></textarea>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="renderPrompt"
              class="rounded-lg border border-indigo-200 bg-indigo-50 px-4 py-2 text-sm font-medium text-indigo-700 transition hover:bg-indigo-100">Render</button>
            <button id="askBtn"
              class="rounded-lg border border-purple-200 bg-purple-50 px-4 py-2 text-sm font-medium text-purple-700 transition hover:bg-purple-100">Send to Mindloom</button>
          </div>
          <pre id="promptResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>New Project</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-4 text-sm text-gray-600">
          <p class="text-xs text-gray-500">
            Create a markdown project in your vault with optional checklist items. Title, slug, status, area and effort are
            required.
          </p>
          <form id="newProjectForm" class="space-y-4" novalidate>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="projectTitle" class="text-sm font-medium text-gray-700">Title</label>
                <input id="projectTitle" name="projectTitle" type="text" required
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Project title" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="projectSlug" class="text-sm font-medium text-gray-700">Slug / file path</label>
                <input id="projectSlug" name="projectSlug" type="text" required
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="projects/new-idea" />
                <span class="text-xs text-gray-500">The `.md` extension is added automatically if omitted.</span>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="flex flex-col gap-1">
                <label for="projectStatus" class="text-sm font-medium text-gray-700">Status</label>
                <select id="projectStatus" name="projectStatus" required
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                  <option value="active">active</option>
                  <option value="paused">paused</option>
                  <option value="complete">complete</option>
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="projectArea" class="text-sm font-medium text-gray-700">Area</label>
                <input id="projectArea" name="projectArea" type="text" required
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Life area" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="projectEffort" class="text-sm font-medium text-gray-700">Effort</label>
                <select id="projectEffort" name="projectEffort" required
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                  <option value="low">low</option>
                  <option value="medium" selected>medium</option>
                  <option value="high">high</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="flex flex-col gap-1">
                <label for="projectDue" class="text-sm font-medium text-gray-700">Due date</label>
                <input id="projectDue" name="projectDue" type="date"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="projectRecurrence" class="text-sm font-medium text-gray-700">Recurrence</label>
                <select id="projectRecurrence" name="projectRecurrence"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                  <option value=""></option>
                  <option value="daily">daily</option>
                  <option value="weekly">weekly</option>
                  <option value="monthly">monthly</option>
                  <option value="yearly">yearly</option>
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="projectLastCompleted" class="text-sm font-medium text-gray-700">Last completed</label>
                <input id="projectLastCompleted" name="projectLastCompleted" type="date"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="projectExecutiveTrigger" class="text-sm font-medium text-gray-700">Executive trigger</label>
                <select id="projectExecutiveTrigger" name="projectExecutiveTrigger"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                  <option value=""></option>
                  <option value="low">low</option>
                  <option value="medium">medium</option>
                  <option value="high">high</option>
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="projectLastReviewed" class="text-sm font-medium text-gray-700">Last reviewed</label>
                <input id="projectLastReviewed" name="projectLastReviewed" type="date"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
              </div>
            </div>
            <div class="flex flex-col gap-1">
              <label for="projectChecklist" class="text-sm font-medium text-gray-700">Initial checklist</label>
              <textarea id="projectChecklist" name="projectChecklist" rows="3"
                class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                placeholder="One task per line"></textarea>
              <span class="text-xs text-gray-500">Checklist items become tasks in the new file.</span>
            </div>
            <div id="newProjectFeedback" class="hidden text-sm"></div>
            <div class="flex flex-wrap justify-end gap-2">
              <button type="reset"
                class="inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-200">
                Clear
              </button>
              <button id="createProjectBtn" type="submit"
                class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 px-5 py-2 text-sm font-semibold text-white shadow-lg transition hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400">
                Create project
              </button>
            </div>
          </form>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Parse Projects</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="parseBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Parse</button>
            <button id="tasksBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Save Tasks</button>
            <button id="writeTasksBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Write Tasks</button>
          </div>
          <pre id="parseResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
          <pre id="tasksResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
          <pre id="writeTasksResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Record Energy</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <p class="text-sm text-gray-500">Update your energy, mood, and time blocks above, then record a snapshot for your log.</p>
          <div>
            <button id="recordBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Record</button>
          </div>
          <pre id="recordResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Data</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="loadProjects"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Projects</button>
            <button id="loadEnergy"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Energy</button>
          </div>
          <pre id="projects"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
          <pre id="energyData"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>
    </div>
  </div>


<script>
const projectTitleInput = document.getElementById('projectTitle');
const projectSlugInput = document.getElementById('projectSlug');
const projectStatusSelect = document.getElementById('projectStatus');
const projectAreaInput = document.getElementById('projectArea');
const projectEffortSelect = document.getElementById('projectEffort');
const projectDueInput = document.getElementById('projectDue');
const projectRecurrenceSelect = document.getElementById('projectRecurrence');
const projectLastCompletedInput = document.getElementById('projectLastCompleted');
const projectExecutiveTriggerSelect = document.getElementById('projectExecutiveTrigger');
const projectLastReviewedInput = document.getElementById('projectLastReviewed');
const projectChecklistInput = document.getElementById('projectChecklist');
const projectForm = document.getElementById('newProjectForm');
const projectFeedbackEl = document.getElementById('newProjectFeedback');
const createProjectBtn = document.getElementById('createProjectBtn');

const requiredProjectFields = [
  { element: projectTitleInput, message: 'Project title is required.' },
  { element: projectSlugInput, message: 'Provide a slug or relative file path.' },
  { element: projectStatusSelect, message: 'Select the project status.' },
  { element: projectAreaInput, message: 'Add a life area for the project.' },
  { element: projectEffortSelect, message: 'Choose an effort level.' },
];

requiredProjectFields.forEach(({ element }) => {
  if (element) {
    attachFieldValidation(element);
  }
});

let projectSlugManuallyEdited = false;

function sanitizeSlug(value) {
  if (!value) {
    return '';
  }
  return value
    .normalize('NFKD')
    .replace(/[̀-ͯ]/g, '')
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9/]+/g, '-')
    .replace(/-{2,}/g, '-')
    .replace(/^-+|-+$/g, '');
}

if (projectTitleInput && projectSlugInput) {
  projectTitleInput.addEventListener('input', () => {
    if (!projectSlugManuallyEdited) {
      projectSlugInput.value = sanitizeSlug(projectTitleInput.value);
    }
  });

  projectSlugInput.addEventListener('focus', () => {
    projectSlugManuallyEdited = true;
  });

  projectSlugInput.addEventListener('input', () => {
    const sanitized = sanitizeSlug(projectSlugInput.value);
    projectSlugInput.value = sanitized;
    projectSlugManuallyEdited = sanitized.length > 0;
  });

  projectSlugInput.addEventListener('blur', () => {
    if (!projectSlugInput.value) {
      projectSlugManuallyEdited = false;
      projectSlugInput.value = sanitizeSlug(projectTitleInput.value);
    }
  });
}

if (projectForm && createProjectBtn) {
  const submitProject = performActionWithFeedback(createProjectBtn, {
    loadingText: 'Creating…',
    errorMessage: 'Unable to create project',
    action: async () => {
      clearFeedback(projectFeedbackEl);
      const ok = validateRequiredFields(requiredProjectFields, {
        feedbackEl: projectFeedbackEl,
        summaryMessage: 'Please complete the required project fields before creating the file.',
      });
      if (!ok) {
        return null;
      }

      const slugValue = sanitizeSlug(projectSlugInput.value);
      if (!slugValue) {
        setFieldValidity(projectSlugInput, false);
        updateFeedback(projectFeedbackEl, 'Slug cannot be empty after sanitization.', 'error');
        return null;
      }

      const payload = {
        title: projectTitleInput.value.trim(),
        slug: slugValue.endsWith('.md') ? slugValue : `${slugValue}.md`,
        status: projectStatusSelect.value,
        area: projectAreaInput.value.trim(),
        effort: projectEffortSelect.value,
      };

      const optionalFields = [
        { element: projectDueInput, key: 'due' },
        { element: projectRecurrenceSelect, key: 'recurrence' },
        { element: projectLastCompletedInput, key: 'last_completed' },
        { element: projectExecutiveTriggerSelect, key: 'executive_trigger' },
        { element: projectLastReviewedInput, key: 'last_reviewed' },
      ];
      optionalFields.forEach(({ element, key }) => {
        if (!element) {
          return;
        }
        const value = (element.value || '').trim();
        if (value) {
          payload[key] = value;
        }
      });

      if (projectChecklistInput && projectChecklistInput.value.trim()) {
        const tasks = projectChecklistInput.value
          .split('\n')
          .map((line) => line.trim())
          .filter((line) => line.length > 0)
          .map((title) => ({ title }));
        if (tasks.length) {
          payload.tasks = tasks;
        }
      }

      const res = await fetch('/projects', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      ensureOkResponse(res);
      const data = await res.json();
      updateFeedback(
        projectFeedbackEl,
        `Created “${data.title || payload.title}” at ${data.path || payload.slug}.`,
        'success',
      );
      projectForm.reset();
      projectSlugManuallyEdited = false;
      if (projectSlugInput) {
        projectSlugInput.value = '';
      }
      if (projectTitleInput) {
        projectTitleInput.focus();
      }
      return data;
    },
  });

  projectForm.addEventListener('submit', (event) => {
    event.preventDefault();
    submitProject();
  });

  projectForm.addEventListener('reset', () => {
    clearFeedback(projectFeedbackEl);
    projectSlugManuallyEdited = false;
    if (projectSlugInput) {
      projectSlugInput.value = '';
    }
    setTimeout(() => {
      if (projectTitleInput && projectSlugInput && projectTitleInput.value) {
        projectSlugInput.value = sanitizeSlug(projectTitleInput.value);
      }
    }, 0);
  });
}

const parseBtn = document.getElementById('parseBtn');
if (parseBtn) {
  parseBtn.onclick = performActionWithFeedback(parseBtn, {
    loadingText: 'Parsing…',
    preId: 'parseResult',
    errorMessage: 'Unable to parse projects',
    action: async () => {
      const res = await fetch('/parse-projects', { method: 'POST' });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('parseResult', JSON.stringify(data, null, 2));
    }
  });
}

const tasksBtn = document.getElementById('tasksBtn');
if (tasksBtn) {
  tasksBtn.onclick = performActionWithFeedback(tasksBtn, {
    loadingText: 'Saving…',
    preId: 'tasksResult',
    errorMessage: 'Unable to save tasks',
    action: async () => {
      const res = await fetch('/save-tasks', { method: 'POST' });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('tasksResult', JSON.stringify(data, null, 2));
    }
  });
}

const writeTasksBtn = document.getElementById('writeTasksBtn');
if (writeTasksBtn) {
  writeTasksBtn.onclick = performActionWithFeedback(writeTasksBtn, {
    loadingText: 'Writing…',
    preId: 'writeTasksResult',
    errorMessage: 'Unable to write tasks',
    action: async () => {
      const res = await fetch('/write-tasks', { method: 'POST' });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('writeTasksResult', JSON.stringify(data, null, 2));
    }
  });
}

const recordBtn = document.getElementById('recordBtn');
if (recordBtn) {
  recordBtn.onclick = performActionWithFeedback(recordBtn, {
    loadingText: 'Recording…',
    preId: 'recordResult',
    errorMessage: 'Unable to record energy',
    action: async () => {
      const payload = {
        energy: parseInt(document.getElementById('energy').value),
        mood: document.getElementById('mood').value,
        time_blocks: parseInt(document.getElementById('timeBlocks').value || '0')
      };
      const res = await fetch('/energy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('recordResult', JSON.stringify(data, null, 2));
    }
  });
}

const loadProjectsBtn = document.getElementById('loadProjects');
if (loadProjectsBtn) {
  loadProjectsBtn.onclick = performActionWithFeedback(loadProjectsBtn, {
    loadingText: 'Loading…',
    preId: 'projects',
    errorMessage: 'Unable to load projects',
    action: async () => {
      const res = await fetch('/projects');
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('projects', JSON.stringify(data, null, 2));
    }
  });
}

const loadEnergyBtn = document.getElementById('loadEnergy');
if (loadEnergyBtn) {
  loadEnergyBtn.onclick = performActionWithFeedback(loadEnergyBtn, {
    loadingText: 'Loading…',
    preId: 'energyData',
    errorMessage: 'Unable to load energy data',
    action: async () => {
      const res = await fetch('/energy');
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('energyData', JSON.stringify(data, null, 2));
    }
  });
}

const plannerModeSelect = document.getElementById('plannerMode');
const focusAskBtn = document.getElementById('focusAskBtn');

async function requestPlan(mode) {
  const effectiveMode = mode || 'next_task';
  const energyEl = document.getElementById('energy');
  const moodEl = document.getElementById('mood');
  const timeBlocksEl = document.getElementById('timeBlocks');
  const askResultEl = document.getElementById('askResult');

  let requestBody = null;
  if (effectiveMode === 'next_task') {
    const energyValue = energyEl ? energyEl.value : '';
    const moodValue = moodEl ? moodEl.value : '';
    const timeBlocksValue = timeBlocksEl ? timeBlocksEl.value : '';

    if (!energyValue || !moodValue || timeBlocksValue === '') {
      const message = '⚠️ Please select your energy, mood, and available time blocks before asking for the next task.';
      setPreContent(askResultEl, message);
      return;
    }

    const parsedEnergy = Number.parseInt(energyValue, 10);
    const parsedTimeBlocks = Number.parseInt(timeBlocksValue, 10);

    if (Number.isNaN(parsedEnergy) || Number.isNaN(parsedTimeBlocks)) {
      const message = '⚠️ Energy and time blocks must be valid numbers to request the next task.';
      setPreContent(askResultEl, message);
      return;
    }

    requestBody = {
      energy: parsedEnergy,
      mood: moodValue,
      time_blocks: parsedTimeBlocks,
    };
  }

  const fetchOptions = { method: 'POST' };
  if (requestBody) {
    fetchOptions.headers = { 'Content-Type': 'application/json' };
    fetchOptions.body = JSON.stringify(requestBody);
  }

  const res = await fetch(`/plan?mode=${encodeURIComponent(effectiveMode)}`, fetchOptions);
  ensureOkResponse(res);
  const data = await res.json();
  if (effectiveMode === 'next_task') {
    if (data.next_task) {
      setPreContent(askResultEl, JSON.stringify(data.next_task, null, 2));
    } else if (data.plan) {
      setPreContent(askResultEl, data.plan);
    } else {
      setPreContent(askResultEl, JSON.stringify(data, null, 2));
    }
    return;
  }
  if (data.plan) {
    setPreContent(askResultEl, data.plan);
  } else {
    setPreContent(askResultEl, JSON.stringify(data, null, 2));
  }
  window.location.href = '/daily-tasks';
}

if (focusAskBtn) {
  focusAskBtn.onclick = performActionWithFeedback(focusAskBtn, {
    loadingText: 'Asking…',
    preId: 'askResult',
    errorMessage: 'Unable to load plan',
    action: async () => {
      const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
      await requestPlan(mode);
    }
  });
}

async function renderPromptAction() {
  const select = document.getElementById('promptSelect');
  const varsText = document.getElementById('promptVars').value || '{}';
  let variables = {};
  try {
    variables = JSON.parse(varsText);
  } catch {
    alert('Invalid JSON in variables');
    return;
  }
  const warnings = [];
  try {
    const tasksRes = await fetch('/tasks');
    ensureOkResponse(tasksRes);
    const tasksData = await tasksRes.json();
    if (!select.value.endsWith('morning_planner.txt')) {
      variables.tasks = tasksData;
    }
  } catch (e) {
    warnings.push(`⚠️ Unable to load tasks data. ${e.message || ''}`.trim());
  }
  try {
    const energyRes = await fetch('/energy');
    ensureOkResponse(energyRes);
    const energyData = await energyRes.json();
    const latest = energyData[energyData.length - 1];
    if (latest) {
      if (!('time_blocks' in variables)) {
        variables.time_blocks = latest.time_blocks;
      }
      if (!('energy' in variables)) {
        variables.energy = latest.energy;
      }
      if (!('mood' in variables)) {
        variables.mood = latest.mood;
      }
    }
  } catch (e) {
    warnings.push(`⚠️ Unable to load energy data. ${e.message || ''}`.trim());
  }
  const payload = { template: select.value, variables };
  const res = await fetch('/render-prompt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  ensureOkResponse(res);
  const data = await res.json();
  const resultContent = data.result ? data.result : JSON.stringify(data, null, 2);
  if (warnings.length) {
    const combined = [...warnings, '', resultContent].join('\n');
    setPreContent('promptResult', combined.replace(/\n/g, String.fromCharCode(10)));
    return;
  }
  if (data.result) {
    setPreContent('promptResult', data.result);
  } else {
    setPreContent('promptResult', JSON.stringify(data, null, 2));
  }
}

const renderPromptBtn = document.getElementById('renderPrompt');
if (renderPromptBtn) {
  renderPromptBtn.onclick = performActionWithFeedback(renderPromptBtn, {
    loadingText: 'Rendering…',
    preId: 'promptResult',
    errorMessage: 'Unable to render prompt',
    action: renderPromptAction
  });
}

const promptSelect = document.getElementById('promptSelect');
if (promptSelect) {
  promptSelect.onchange = () => {
    if (promptSelect.value.endsWith('morning_planner.txt')) {
      renderPromptAction().catch((error) => {
        console.error('Unable to auto-render prompt', error);
        displayInlineError('promptResult', 'Unable to render prompt', error);
      });
    }
  };
}

const askBtn = document.getElementById('askBtn');
if (askBtn) {
  askBtn.onclick = performActionWithFeedback(askBtn, {
    loadingText: 'Sending…',
    preId: 'askResult',
    errorMessage: 'Unable to process request',
    action: async () => {
      const select = document.getElementById('promptSelect');
      if (select.value.endsWith('morning_planner.txt')) {
        const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
        await requestPlan(mode);
        return;
      }

      const promptResultEl = document.getElementById('promptResult');
      if (isPlaceholder(promptResultEl)) {
        alert('Render a prompt first');
        return;
      }
      const prompt = promptResultEl.textContent.trim();
      if (!prompt) {
        alert('Render a prompt first');
        return;
      }
      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      ensureOkResponse(res);
      const data = await res.json();
      if (data.response) {
        setPreContent('askResult', data.response);
      } else {
        setPreContent('askResult', JSON.stringify(data, null, 2));
      }
    }
  });
}
</script>

{% endblock %}
