{% extends "base.html" %}
{% block title %}Mindloom{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-6">
    <section
      class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold">Pick my next task</h1>
        <p class="text-lg text-indigo-100">
          Quickly focus on what matters most. Choose your planning focus and let Mindloom surface the next best step.
        </p>
      </div>
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
        <label for="plannerMode" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Focus</label>
        <select id="plannerMode"
          class="flex-1 rounded-lg border-0 bg-white/10 text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
          <option value="next_task" selected>Next task</option>
          <option value="plan">Daily plan</option>
        </select>
        <button id="focusAskBtn"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-6 py-3 text-lg font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200">
          Ask Mindloom
        </button>
      </div>
      <pre id="askResult"
        class="bg-indigo-900/40 border border-white/20 rounded-2xl p-4 text-sm font-mono whitespace-pre-wrap overflow-auto"></pre>
    </section>

    <div class="space-y-4">
      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Prompts &amp; Templates</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">â–¼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-3 sm:flex-row">
            <select id="promptSelect"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              {% for p in prompt_files %}
              <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <textarea id="promptVars" placeholder='{"energy":5}'
              class="flex-1 min-h-[48px] rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"></textarea>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="renderPrompt"
              class="rounded-lg border border-indigo-200 bg-indigo-50 px-4 py-2 text-sm font-medium text-indigo-700 transition hover:bg-indigo-100">Render</button>
            <button id="askBtn"
              class="rounded-lg border border-purple-200 bg-purple-50 px-4 py-2 text-sm font-medium text-purple-700 transition hover:bg-purple-100">Send to Mindloom</button>
          </div>
          <pre id="promptResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Parse Projects</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">â–¼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="parseBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Parse</button>
            <button id="tasksBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Save Tasks</button>
            <button id="writeTasksBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Write Tasks</button>
          </div>
          <pre id="parseResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
          <pre id="tasksResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
          <pre id="writeTasksResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Record Energy</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">â–¼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <select id="energy"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              <option value="1">ğŸª« Drained</option>
              <option value="2">ğŸ˜´ Low</option>
              <option value="3">ğŸ™‚ OK</option>
              <option value="4">âš¡ Energized</option>
              <option value="5">ğŸ’¥ Turbo</option>
            </select>
            <select id="mood"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              <option value="Sad">ğŸ˜” Sad</option>
              <option value="Meh">ğŸ˜ Meh</option>
              <option value="Okay">ğŸ˜Š Okay</option>
              <option value="Joyful">ğŸ˜ Joyful</option>
            </select>
            <input id="timeBlocks" type="number" step="1" placeholder="Time blocks free"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
            <button id="recordBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Record</button>
          </div>
          <pre id="recordResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Data</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">â–¼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="loadProjects"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Projects</button>
            <button id="loadEnergy"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Energy</button>
          </div>
          <pre id="projects"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
          <pre id="energyData"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono text-gray-700 whitespace-pre-wrap overflow-auto"></pre>
        </div>
      </details>
    </div>
  </div>

<script>
const parseBtn = document.getElementById('parseBtn');
parseBtn.onclick = async () => {
  const res = await fetch('/parse-projects', {method: 'POST'});
  const data = await res.json();
  document.getElementById('parseResult').textContent = JSON.stringify(data, null, 2);
};

const tasksBtn = document.getElementById('tasksBtn');
tasksBtn.onclick = async () => {
  const res = await fetch('/save-tasks', {method: 'POST'});
  const data = await res.json();
  document.getElementById('tasksResult').textContent = JSON.stringify(data, null, 2);
};

const writeTasksBtn = document.getElementById('writeTasksBtn');
writeTasksBtn.onclick = async () => {
  const res = await fetch('/write-tasks', {method: 'POST'});
  const data = await res.json();
  document.getElementById('writeTasksResult').textContent = JSON.stringify(data, null, 2);
};

const recordBtn = document.getElementById('recordBtn');
recordBtn.onclick = async () => {
  const payload = {
    energy: parseInt(document.getElementById('energy').value),
    mood: document.getElementById('mood').value,
    time_blocks: parseInt(document.getElementById('timeBlocks').value || '0')
  };
  const res = await fetch('/energy', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  document.getElementById('recordResult').textContent = JSON.stringify(data, null, 2);
};

document.getElementById('loadProjects').onclick = async () => {
  const res = await fetch('/projects');
  const data = await res.json();
  document.getElementById('projects').textContent = JSON.stringify(data, null, 2);
};

document.getElementById('loadEnergy').onclick = async () => {
  const res = await fetch('/energy');
  const data = await res.json();
  document.getElementById('energyData').textContent = JSON.stringify(data, null, 2);
};

const plannerModeSelect = document.getElementById('plannerMode');
const focusAskBtn = document.getElementById('focusAskBtn');

async function requestPlan(mode) {
  const effectiveMode = mode || 'next_task';
  const res = await fetch(`/plan?mode=${encodeURIComponent(effectiveMode)}`, { method: 'POST' });
  const data = await res.json();
  const askResultEl = document.getElementById('askResult');
  if (effectiveMode === 'next_task') {
    if (data.next_task) {
      askResultEl.textContent = JSON.stringify(data.next_task, null, 2);
    } else if (data.plan) {
      askResultEl.textContent = data.plan;
    } else {
      askResultEl.textContent = JSON.stringify(data, null, 2);
    }
    return;
  }
  if (data.plan) {
    askResultEl.textContent = data.plan;
  } else {
    askResultEl.textContent = JSON.stringify(data, null, 2);
  }
  window.location.href = '/daily-tasks';
}

if (focusAskBtn) {
  focusAskBtn.onclick = async () => {
    const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
    await requestPlan(mode);
  };
}

async function renderPromptAction() {
  const select = document.getElementById('promptSelect');
  const varsText = document.getElementById('promptVars').value || '{}';
  let variables = {};
  try {
    variables = JSON.parse(varsText);
  } catch {
    alert('Invalid JSON in variables');
    return;
  }
  try {
    const tasksRes = await fetch('/tasks');
    if (tasksRes.ok) {
      const tasksData = await tasksRes.json();
      if (!select.value.endsWith('morning_planner.txt')) {
        variables.tasks = tasksData;
      }
    }
  } catch (e) {
    console.error('Failed to load tasks', e);
  }
  try {
    const energyRes = await fetch('/energy');
    if (energyRes.ok) {
      const energyData = await energyRes.json();
      const latest = energyData[energyData.length - 1];
      if (latest) {
        if (!('time_blocks' in variables)) {
          variables.time_blocks = latest.time_blocks;
        }
        if (!('energy' in variables)) {
          variables.energy = latest.energy;
        }
        if (!('mood' in variables)) {
          variables.mood = latest.mood;
        }
      }
    }
  } catch (e) {
    console.error('Failed to load energy data', e);
  }
  const payload = { template: select.value, variables };
  const res = await fetch('/render-prompt', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  document.getElementById('promptResult').textContent = data.result;
}

document.getElementById('renderPrompt').onclick = renderPromptAction;

const promptSelect = document.getElementById('promptSelect');
promptSelect.onchange = () => {
  if (promptSelect.value.endsWith('morning_planner.txt')) {
    renderPromptAction();
  }
};

document.getElementById('askBtn').onclick = async () => {
  const select = document.getElementById('promptSelect');
  if (select.value.endsWith('morning_planner.txt')) {
    const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
    await requestPlan(mode);
    return;
  }

  const prompt = document.getElementById('promptResult').textContent.trim();
  if (!prompt) {
    alert('Render a prompt first');
    return;
  }
  const res = await fetch('/ask', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });
  const data = await res.json();
  if (data.response) {
    document.getElementById('askResult').textContent = data.response;
  } else {
    document.getElementById('askResult').textContent = JSON.stringify(data, null, 2);
  }
};
</script>
{% endblock %}
