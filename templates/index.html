{% extends "base.html" %}
{% block title %}Mindloom{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-6">
    <section
      class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold">Pick my next task</h1>
        <p class="text-lg text-indigo-100">
          Quickly focus on what matters most. Choose your planning focus and let Mindloom surface the next best step.
        </p>
      </div>
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
        <label for="plannerMode" class="text-sm font-medium uppercase tracking-wide text-indigo-100">Focus</label>
        <select id="plannerMode"
          class="flex-1 rounded-lg border-0 bg-white/10 text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none py-2 px-3">
          <option value="next_task" selected>Next task</option>
          <option value="plan">Daily plan</option>
        </select>
        <button id="focusAskBtn"
          class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-6 py-3 text-lg font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200">
          Ask Mindloom
        </button>
      </div>
      <pre id="askResult"
        class="bg-indigo-900/40 border border-white/20 rounded-2xl p-4 text-sm font-mono whitespace-pre-wrap overflow-auto min-h-48 text-indigo-200 data-placeholder"
        data-placeholder-class="text-indigo-200" data-active-class="text-white">Results will appear here…</pre>
    </section>

    <div class="space-y-4">
      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Prompts &amp; Templates</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-3 sm:flex-row">
            <select id="promptSelect"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              {% for p in prompt_files %}
              <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <textarea id="promptVars" placeholder='{"energy":5}'
              class="flex-1 min-h-[48px] rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"></textarea>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="renderPrompt"
              class="rounded-lg border border-indigo-200 bg-indigo-50 px-4 py-2 text-sm font-medium text-indigo-700 transition hover:bg-indigo-100">Render</button>
            <button id="askBtn"
              class="rounded-lg border border-purple-200 bg-purple-50 px-4 py-2 text-sm font-medium text-purple-700 transition hover:bg-purple-100">Send to Mindloom</button>
          </div>
          <pre id="promptResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Parse Projects</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="parseBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Parse</button>
            <button id="tasksBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Save Tasks</button>
            <button id="writeTasksBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Write Tasks</button>
          </div>
          <pre id="parseResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
          <pre id="tasksResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
          <pre id="writeTasksResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Record Energy</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <select id="energy"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              <option value="1">🪫 Drained</option>
              <option value="2">😴 Low</option>
              <option value="3">🙂 OK</option>
              <option value="4">⚡ Energized</option>
              <option value="5">💥 Turbo</option>
            </select>
            <select id="mood"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
              <option value="Sad">😔 Sad</option>
              <option value="Meh">😐 Meh</option>
              <option value="Okay">😊 Okay</option>
              <option value="Joyful">😍 Joyful</option>
            </select>
            <input id="timeBlocks" type="number" step="1" placeholder="Time blocks free"
              class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
            <button id="recordBtn"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Record</button>
          </div>
          <pre id="recordResult"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>

      <details class="group rounded-2xl border border-gray-200 bg-white/70 p-5 shadow-sm">
        <summary class="cursor-pointer select-none text-base font-semibold text-gray-700 flex items-center justify-between">
          <span>Data</span>
          <span class="ml-2 text-xs uppercase tracking-wide text-gray-400 group-open:rotate-180 transition-transform">▼</span>
        </summary>
        <div class="mt-4 space-y-3 text-sm text-gray-600">
          <div class="flex flex-col gap-2 sm:flex-row">
            <button id="loadProjects"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Projects</button>
            <button id="loadEnergy"
              class="rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100">Load Energy</button>
          </div>
          <pre id="projects"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
          <pre id="energyData"
            class="rounded-xl bg-gray-100 p-3 text-xs font-mono whitespace-pre-wrap overflow-auto min-h-32 text-gray-400 data-placeholder"
            data-placeholder-class="text-gray-400" data-active-class="text-gray-700">Results will appear here…</pre>
        </div>
      </details>
    </div>
  </div>


<script>
function setPreContent(target, text) {
  const el = typeof target === 'string' ? document.getElementById(target) : target;
  if (!el) {
    return;
  }
  el.textContent = text;
  if (el.classList.contains('data-placeholder')) {
    const placeholderClass = el.dataset.placeholderClass;
    if (placeholderClass) {
      el.classList.remove(placeholderClass);
    }
    const activeClass = el.dataset.activeClass;
    if (activeClass) {
      el.classList.add(activeClass);
    }
    el.classList.remove('data-placeholder');
  }
}

function isPlaceholder(target) {
  const el = typeof target === 'string' ? document.getElementById(target) : target;
  return !!el && el.classList.contains('data-placeholder');
}

function displayInlineError(target, baseMessage, error) {
  const details = error && error.message ? ` Details: ${error.message}` : '';
  setPreContent(target, `⚠️ ${baseMessage}. ${details}`.trim());
}

function performActionWithFeedback(button, {loadingText = 'Loading…', preId, errorMessage, action}) {
  if (!button) {
    return () => {};
  }
  return async (...args) => {
    if (button.disabled) {
      return;
    }
    const originalHtml = button.innerHTML;
    const originalAriaBusy = button.getAttribute('aria-busy');
    button.disabled = true;
    button.classList.add('cursor-not-allowed', 'opacity-70', 'animate-pulse');
    button.setAttribute('aria-busy', 'true');
    button.innerHTML = `<span class="flex items-center justify-center gap-2"><span class="h-2.5 w-2.5 rounded-full border-2 border-current border-t-transparent animate-spin"></span>${loadingText}</span>`;
    try {
      return await action(...args);
    } catch (error) {
      console.error(errorMessage, error);
      if (preId) {
        displayInlineError(preId, errorMessage, error);
      }
      return null;
    } finally {
      button.disabled = false;
      button.innerHTML = originalHtml;
      button.classList.remove('cursor-not-allowed', 'opacity-70', 'animate-pulse');
      if (originalAriaBusy !== null) {
        button.setAttribute('aria-busy', originalAriaBusy);
      } else {
        button.removeAttribute('aria-busy');
      }
    }
  };
}

function ensureOkResponse(response) {
  if (!response.ok) {
    throw new Error(`Server responded with status ${response.status}`);
  }
}

const parseBtn = document.getElementById('parseBtn');
if (parseBtn) {
  parseBtn.onclick = performActionWithFeedback(parseBtn, {
    loadingText: 'Parsing…',
    preId: 'parseResult',
    errorMessage: 'Unable to parse projects',
    action: async () => {
      const res = await fetch('/parse-projects', { method: 'POST' });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('parseResult', JSON.stringify(data, null, 2));
    }
  });
}

const tasksBtn = document.getElementById('tasksBtn');
if (tasksBtn) {
  tasksBtn.onclick = performActionWithFeedback(tasksBtn, {
    loadingText: 'Saving…',
    preId: 'tasksResult',
    errorMessage: 'Unable to save tasks',
    action: async () => {
      const res = await fetch('/save-tasks', { method: 'POST' });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('tasksResult', JSON.stringify(data, null, 2));
    }
  });
}

const writeTasksBtn = document.getElementById('writeTasksBtn');
if (writeTasksBtn) {
  writeTasksBtn.onclick = performActionWithFeedback(writeTasksBtn, {
    loadingText: 'Writing…',
    preId: 'writeTasksResult',
    errorMessage: 'Unable to write tasks',
    action: async () => {
      const res = await fetch('/write-tasks', { method: 'POST' });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('writeTasksResult', JSON.stringify(data, null, 2));
    }
  });
}

const recordBtn = document.getElementById('recordBtn');
if (recordBtn) {
  recordBtn.onclick = performActionWithFeedback(recordBtn, {
    loadingText: 'Recording…',
    preId: 'recordResult',
    errorMessage: 'Unable to record energy',
    action: async () => {
      const payload = {
        energy: parseInt(document.getElementById('energy').value),
        mood: document.getElementById('mood').value,
        time_blocks: parseInt(document.getElementById('timeBlocks').value || '0')
      };
      const res = await fetch('/energy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('recordResult', JSON.stringify(data, null, 2));
    }
  });
}

const loadProjectsBtn = document.getElementById('loadProjects');
if (loadProjectsBtn) {
  loadProjectsBtn.onclick = performActionWithFeedback(loadProjectsBtn, {
    loadingText: 'Loading…',
    preId: 'projects',
    errorMessage: 'Unable to load projects',
    action: async () => {
      const res = await fetch('/projects');
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('projects', JSON.stringify(data, null, 2));
    }
  });
}

const loadEnergyBtn = document.getElementById('loadEnergy');
if (loadEnergyBtn) {
  loadEnergyBtn.onclick = performActionWithFeedback(loadEnergyBtn, {
    loadingText: 'Loading…',
    preId: 'energyData',
    errorMessage: 'Unable to load energy data',
    action: async () => {
      const res = await fetch('/energy');
      ensureOkResponse(res);
      const data = await res.json();
      setPreContent('energyData', JSON.stringify(data, null, 2));
    }
  });
}

const plannerModeSelect = document.getElementById('plannerMode');
const focusAskBtn = document.getElementById('focusAskBtn');

async function requestPlan(mode) {
  const effectiveMode = mode || 'next_task';
  const res = await fetch(`/plan?mode=${encodeURIComponent(effectiveMode)}`, { method: 'POST' });
  ensureOkResponse(res);
  const data = await res.json();
  const askResultEl = document.getElementById('askResult');
  if (effectiveMode === 'next_task') {
    if (data.next_task) {
      setPreContent(askResultEl, JSON.stringify(data.next_task, null, 2));
    } else if (data.plan) {
      setPreContent(askResultEl, data.plan);
    } else {
      setPreContent(askResultEl, JSON.stringify(data, null, 2));
    }
    return;
  }
  if (data.plan) {
    setPreContent(askResultEl, data.plan);
  } else {
    setPreContent(askResultEl, JSON.stringify(data, null, 2));
  }
  window.location.href = '/daily-tasks';
}

if (focusAskBtn) {
  focusAskBtn.onclick = performActionWithFeedback(focusAskBtn, {
    loadingText: 'Asking…',
    preId: 'askResult',
    errorMessage: 'Unable to load plan',
    action: async () => {
      const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
      await requestPlan(mode);
    }
  });
}

async function renderPromptAction() {
  const select = document.getElementById('promptSelect');
  const varsText = document.getElementById('promptVars').value || '{}';
  let variables = {};
  try {
    variables = JSON.parse(varsText);
  } catch {
    alert('Invalid JSON in variables');
    return;
  }
  const warnings = [];
  try {
    const tasksRes = await fetch('/tasks');
    ensureOkResponse(tasksRes);
    const tasksData = await tasksRes.json();
    if (!select.value.endsWith('morning_planner.txt')) {
      variables.tasks = tasksData;
    }
  } catch (e) {
    warnings.push(`⚠️ Unable to load tasks data. ${e.message || ''}`.trim());
  }
  try {
    const energyRes = await fetch('/energy');
    ensureOkResponse(energyRes);
    const energyData = await energyRes.json();
    const latest = energyData[energyData.length - 1];
    if (latest) {
      if (!('time_blocks' in variables)) {
        variables.time_blocks = latest.time_blocks;
      }
      if (!('energy' in variables)) {
        variables.energy = latest.energy;
      }
      if (!('mood' in variables)) {
        variables.mood = latest.mood;
      }
    }
  } catch (e) {
    warnings.push(`⚠️ Unable to load energy data. ${e.message || ''}`.trim());
  }
  const payload = { template: select.value, variables };
  const res = await fetch('/render-prompt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  ensureOkResponse(res);
  const data = await res.json();
  const resultContent = data.result ? data.result : JSON.stringify(data, null, 2);
  if (warnings.length) {
    const combined = [...warnings, '', resultContent].join('\n');
    setPreContent('promptResult', combined.replace(/\n/g, String.fromCharCode(10)));
    return;
  }
  if (data.result) {
    setPreContent('promptResult', data.result);
  } else {
    setPreContent('promptResult', JSON.stringify(data, null, 2));
  }
}

const renderPromptBtn = document.getElementById('renderPrompt');
if (renderPromptBtn) {
  renderPromptBtn.onclick = performActionWithFeedback(renderPromptBtn, {
    loadingText: 'Rendering…',
    preId: 'promptResult',
    errorMessage: 'Unable to render prompt',
    action: renderPromptAction
  });
}

const promptSelect = document.getElementById('promptSelect');
if (promptSelect) {
  promptSelect.onchange = () => {
    if (promptSelect.value.endsWith('morning_planner.txt')) {
      renderPromptAction().catch((error) => {
        console.error('Unable to auto-render prompt', error);
        displayInlineError('promptResult', 'Unable to render prompt', error);
      });
    }
  };
}

const askBtn = document.getElementById('askBtn');
if (askBtn) {
  askBtn.onclick = performActionWithFeedback(askBtn, {
    loadingText: 'Sending…',
    preId: 'askResult',
    errorMessage: 'Unable to process request',
    action: async () => {
      const select = document.getElementById('promptSelect');
      if (select.value.endsWith('morning_planner.txt')) {
        const mode = plannerModeSelect ? plannerModeSelect.value : 'next_task';
        await requestPlan(mode);
        return;
      }

      const promptResultEl = document.getElementById('promptResult');
      if (isPlaceholder(promptResultEl)) {
        alert('Render a prompt first');
        return;
      }
      const prompt = promptResultEl.textContent.trim();
      if (!prompt) {
        alert('Render a prompt first');
        return;
      }
      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      ensureOkResponse(res);
      const data = await res.json();
      if (data.response) {
        setPreContent('askResult', data.response);
      } else {
        setPreContent('askResult', JSON.stringify(data, null, 2));
      }
    }
  });
}
</script>

{% endblock %}
