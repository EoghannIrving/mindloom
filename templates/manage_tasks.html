{% extends "base.html" %}
{% block title %}Edit Tasks{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-8 lg:grid lg:grid-cols-[minmax(18rem,22rem)_1fr] lg:gap-8 lg:space-y-0">
    <aside class="space-y-8 lg:space-y-6 lg:sticky lg:top-6">
      <section class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold">Curate your task list</h1>
        <p class="text-lg text-indigo-100">
          Filter and refine every detail while staying in the same ambient flow as the Mindloom home experience.
        </p>
      </div>
      <form method="get" class="rounded-2xl border border-white/20 bg-white/10 p-5 backdrop-blur space-y-4">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
          <div class="flex flex-col gap-1 sm:col-span-2 md:col-span-2">
            <label for="task-search" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Search</label>
            <input
              id="task-search"
              type="search"
              name="q"
              value="{{ search_query or '' }}"
              placeholder="Search tasks"
              class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label for="status-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Status</label>
            <select
              id="status-filter"
              name="status"
              class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
            >
              <option value="" class="text-gray-900">All</option>
              {% for opt in status_options %}
                <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_status == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
            <p class="text-[11px] text-indigo-100/80">Completed tasks are hidden unless you pick "complete".</p>
          </div>
          <div class="flex flex-col gap-1">
            <label for="project-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Project</label>
            <select
              id="project-filter"
              name="project"
              class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
            >
              <option value="" class="text-gray-900">All</option>
              {% for opt in project_options %}
                <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_project == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label for="area-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Area</label>
            <select
              id="area-filter"
              name="area"
              class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
            >
              <option value="" class="text-gray-900">All</option>
              {% for opt in area_options %}
                <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_area == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label for="type-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Type</label>
            <select
              id="type-filter"
              name="type"
              class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
            >
              <option value="" class="text-gray-900">All</option>
              {% for opt in type_options %}
                <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_type == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label for="sort-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Sort</label>
            <select
              id="sort-filter"
              name="sort"
              class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
            >
              {% for value, label in sort_options %}
                <option value="{{ value }}" style="color: #111827;" class="text-gray-900" {% if selected_sort == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="flex flex-wrap items-center justify-end gap-2">
          <a
            href="{{ url_for('manage_tasks_page') }}"
            class="inline-flex items-center justify-center rounded-lg border border-white/30 bg-white/10 px-4 py-2 text-sm font-medium text-white transition hover:bg-white/20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
          >
            Clear filters
          </a>
          <button
            type="submit"
            class="inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-5 py-2 text-sm font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200"
          >
            Apply filters
          </button>
        </div>
      </form>
    </section>
    <section class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm space-y-4">
      <div class="space-y-1">
        <h2 class="text-xl font-semibold text-gray-800">New Task</h2>
        <p class="text-sm text-gray-600">Capture a task directly from this page and refresh the list automatically.</p>
      </div>
      <form id="newTaskForm" class="space-y-4" novalidate>
        <div class="space-y-4">
          <div class="flex flex-col gap-4 md:flex-row md:flex-wrap md:items-end md:gap-3">
            <div class="flex flex-1 flex-col gap-1">
              <label for="newTaskTitle" class="text-sm font-medium text-gray-700">Title</label>
              <input
                id="newTaskTitle"
                name="newTaskTitle"
                type="text"
                required
                class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                placeholder="Describe the next action"
              />
            </div>
            <div class="flex flex-col gap-1 md:w-48">
              <label for="newTaskDue" class="text-sm font-medium text-gray-700">Due date</label>
              <input
                id="newTaskDue"
                name="newTaskDue"
                type="date"
                class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              />
            </div>
            <div class="flex items-end gap-2 md:basis-full md:justify-end">
              <button
                type="reset"
                class="inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-200"
              >
                Clear
              </button>
              <button
                id="createTaskBtn"
                type="submit"
                class="inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow-lg transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400"
              >
                Create task
              </button>
            </div>
          </div>
          <div id="newTaskFeedback" class="hidden text-sm"></div>
        </div>
        <details id="newTaskAdvanced" class="group rounded-2xl border border-gray-200 bg-gray-50/60 p-4">
          <summary class="flex cursor-pointer items-center justify-between gap-2 rounded-xl px-3 py-2 text-sm font-semibold text-gray-700 focus:outline-none focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400">
            <span>More options</span>
            <span class="text-xs font-medium text-gray-500 group-open:hidden">Show</span>
            <span class="hidden text-xs font-medium text-gray-500 group-open:inline">Hide</span>
          </summary>
          <div class="mt-4 space-y-4">
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="flex flex-col gap-1">
                <label for="newTaskProject" class="text-sm font-medium text-gray-700">Project</label>
                <input
                  id="newTaskProject"
                  name="newTaskProject"
                  type="text"
                  list="newTaskProjects"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Optional project"
                />
              </div>
              <div class="flex flex-col gap-1">
                <label for="newTaskArea" class="text-sm font-medium text-gray-700">Area</label>
                <input
                  id="newTaskArea"
                  name="newTaskArea"
                  type="text"
                  list="newTaskAreas"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Optional life area"
                />
              </div>
              <div class="flex flex-col gap-1">
                <label for="newTaskType" class="text-sm font-medium text-gray-700">Type</label>
                <input
                  id="newTaskType"
                  name="newTaskType"
                  type="text"
                  list="newTaskTypes"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Optional type"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="flex flex-col gap-1">
                <label for="newTaskEffort" class="text-sm font-medium text-gray-700">Effort</label>
                <select
                  id="newTaskEffort"
                  name="newTaskEffort"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                  <option value="low">low</option>
                  <option value="medium">medium</option>
                  <option value="high">high</option>
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="newTaskStatus" class="text-sm font-medium text-gray-700">Status</label>
                <select
                  id="newTaskStatus"
                  name="newTaskStatus"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                  <option value="active" selected>active</option>
                  <option value="complete">complete</option>
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="newTaskRecurrence" class="text-sm font-medium text-gray-700">Recurrence</label>
                <select
                  id="newTaskRecurrence"
                  name="newTaskRecurrence"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                  <option value=""></option>
                  <option value="daily">daily</option>
                  <option value="weekly">weekly</option>
                  <option value="monthly">monthly</option>
                  <option value="yearly">yearly</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="newTaskEnergy" class="text-sm font-medium text-gray-700">Energy cost (1-5)</label>
                <input
                  id="newTaskEnergy"
                  name="newTaskEnergy"
                  type="number"
                  min="1"
                  max="5"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Auto-computed if blank"
                />
              </div>
              <div class="flex flex-col gap-1 md:col-span-2">
                <label for="newTaskNotes" class="text-sm font-medium text-gray-700">Notes</label>
                <textarea
                  id="newTaskNotes"
                  name="newTaskNotes"
                  rows="2"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Optional context"
                ></textarea>
              </div>
            </div>
          </div>
        </details>
        <datalist id="newTaskProjects">
          {% for p in project_options %}
            <option value="{{ p }}">
          {% endfor %}
        </datalist>
        <datalist id="newTaskAreas">
          {% for a in area_options %}
            <option value="{{ a }}">
          {% endfor %}
        </datalist>
        <datalist id="newTaskTypes">
          {% for tp in type_options %}
            <option value="{{ tp }}">
          {% endfor %}
        </datalist>
      </form>
    </section>
    </aside>
    <form method="post" id="manage-tasks-form" class="flex flex-col rounded-3xl border border-gray-200 bg-white/80 shadow-sm">
      <input type="hidden" name="q" value="{{ search_query or '' }}" />
      <input type="hidden" name="status" value="{{ selected_status or '' }}" />
      <input type="hidden" name="project" value="{{ selected_project or '' }}" />
      <input type="hidden" name="area" value="{{ selected_area or '' }}" />
      <input type="hidden" name="type" value="{{ selected_type or '' }}" />
      <input type="hidden" name="sort" value="{{ selected_sort or '' }}" />
      <div class="divide-y divide-gray-200 pt-3" data-task-list>
      {% for t in tasks %}
      {% set status_styles = {
        'complete': 'bg-green-100 text-green-800',
        'active': 'bg-blue-100 text-blue-800',
        'blocked': 'bg-red-100 text-red-800',
        'waiting': 'bg-amber-100 text-amber-800'
      } %}
      {% set status_key = (t.status or 'active')|lower %}
      {% set summary_styles = {
        'complete': 'border border-green-200 bg-green-50/70',
        'active': 'border border-blue-200 bg-blue-50/70',
        'blocked': 'border border-rose-200 bg-rose-50/70',
        'waiting': 'border border-amber-200 bg-amber-50/70'
      } %}
      {% set hover_styles = {
        'complete': 'hover:bg-green-50/70',
        'active': 'hover:bg-indigo-50/40',
        'blocked': 'hover:bg-rose-50/70',
        'waiting': 'hover:bg-amber-50/70'
      } %}
      <input type="hidden" name="delete-{{ t.id }}" value="" data-delete-input data-task-id="{{ t.id }}">
      <details class="group bg-white/90 transition" data-task-details>
        <summary
          class="grid cursor-pointer gap-3 px-4 py-3 text-sm text-slate-600 transition focus:outline-none focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-300 sm:grid-cols-[minmax(0,1fr)_auto] sm:items-center {{ summary_styles.get(status_key, 'border border-gray-200 bg-white/90') }} {{ hover_styles.get(status_key, 'hover:bg-indigo-50/40') }}"
          aria-controls="task-body-{{ t.id }}"
          aria-expanded="false"
          data-task-summary
          data-task-id="{{ t.id }}"
          data-task-status="{{ status_key }}"
        >
          <div class="space-y-2">
            <span class="text-sm font-semibold text-slate-900">{{ t.title or 'Untitled task' }}</span>
            <div class="grid gap-2 text-xs text-slate-500 sm:grid-cols-2">
              <span class="flex items-center gap-1">
                <span class="font-medium text-slate-600">Due</span>
                <span>{{ t.due or 'No due date' }}</span>
              </span>
            </div>
          </div>
          <div class="flex flex-wrap justify-end gap-2 text-xs font-semibold">
            <span
              class="sr-only"
              data-status-pill
              data-task-id="{{ t.id }}"
              aria-live="polite"
            >
              {{ (t.status or 'unknown')|title }}
            </span>
            {% if t.is_overdue %}
              <span class="rounded-full bg-rose-100 px-2 py-1 text-rose-700">
                <span class="sr-only">Overdue</span>
                <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="3" y="5" width="18" height="16" rx="3" ry="3"></rect>
                  <path d="M3 9h18"></path>
                  <path d="M8 1v4"></path>
                  <path d="M16 1v4"></path>
                </svg>
              </span>
            {% elif t.is_due_today %}
              <span class="rounded-full bg-amber-100 px-2 py-1 text-amber-800">
                <span class="sr-only">Due today</span>
                <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="3" y="5" width="18" height="16" rx="3" ry="3"></rect>
                  <path d="M3 9h18"></path>
                  <path d="M8 1v4"></path>
                  <path d="M16 1v4"></path>
                </svg>
              </span>
            {% endif %}
            {% if t.area %}
              <span class="rounded-full bg-slate-100 px-2 py-1 text-slate-600">{{ t.area }}</span>
            {% endif %}
            <button
              type="button"
              class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 transition hover:bg-emerald-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-200"
              aria-label="Mark task complete"
              data-complete-button
              data-task-id="{{ t.id }}"
            >
              <span class="sr-only">Mark task complete</span>
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              type="button"
              class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-rose-200 bg-rose-50 text-rose-600 transition hover:bg-rose-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-200"
              aria-label="Delete task"
              data-delete-button
              data-task-id="{{ t.id }}"
            >
              <span class="sr-only">Delete task</span>
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 6h18" />
                <path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" />
                <path d="M10 11v6" />
                <path d="M14 11v6" />
                <path d="M9 6V4h6v2" />
              </svg>
            </button>
          </div>
        </summary>
        <div id="task-body-{{ t.id }}" class="space-y-5 px-4 py-4">
          <fieldset class="space-y-3">
            <legend class="text-sm font-semibold text-gray-700">General Information</legend>
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="title-{{t.id}}" class="text-sm font-medium text-gray-700">Title</label>
                <input
                  id="title-{{t.id}}"
                  type="text"
                  name="title-{{t.id}}"
                  value="{{ t.title or '' }}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Task title"
                >
              </div>
              <div class="flex flex-col gap-1">
                <label for="due-{{t.id}}" class="text-sm font-medium text-gray-700">Due date</label>
                <input
                  id="due-{{t.id}}"
                  type="date"
                  name="due-{{t.id}}"
                  value="{{ t.due or '' }}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
              </div>
              <div class="flex flex-col gap-1">
                <label for="status-{{t.id}}" class="text-sm font-medium text-gray-700">Status</label>
                <select
                  id="status-{{t.id}}"
                  name="status-{{t.id}}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                    {% for opt in ["active", "complete"] %}
                      <option value="{{ opt }}" {% if t.status == opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                  </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="project-{{t.id}}" class="text-sm font-medium text-gray-700">Project</label>
                <input
                  id="project-{{t.id}}"
                  type="text"
                  name="project-{{t.id}}"
                  value="{{ t.project or '' }}"
                  list="projects"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Choose project"
                >
              </div>
              <div class="flex flex-col gap-1">
                <label for="area-{{t.id}}" class="text-sm font-medium text-gray-700">Life area</label>
                <input
                  id="area-{{t.id}}"
                  type="text"
                  name="area-{{t.id}}"
                  value="{{ t.area or '' }}"
                  list="areas"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Choose area"
                >
              </div>
              <div class="flex flex-col gap-1">
                <label for="type-{{t.id}}" class="text-sm font-medium text-gray-700">Type</label>
                <input
                  id="type-{{t.id}}"
                  type="text"
                  name="type-{{t.id}}"
                  value="{{ t.type or '' }}"
                  list="task-types"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Enter or choose type"
                >
              </div>
            </div>
          </fieldset>
          <fieldset class="space-y-3">
            <legend class="text-sm font-semibold text-gray-700">Effort &amp; Recurrence</legend>
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="effort-{{t.id}}" class="text-sm font-medium text-gray-700">Effort</label>
                <select
                  id="effort-{{t.id}}"
                  name="effort-{{t.id}}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                    {% for opt in ["low", "medium", "high"] %}
                      <option value="{{ opt }}" {% if t.effort == opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                  </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="energy_cost-{{t.id}}" class="text-sm font-medium text-gray-700">Energy cost (1-5)</label>
                <input
                  id="energy_cost-{{t.id}}"
                  type="number"
                  name="energy_cost-{{t.id}}"
                  value="{{ t.energy_cost or '' }}"
                  min="1"
                  max="5"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
              </div>
              <div class="flex flex-col gap-1">
                <label for="executive_trigger-{{t.id}}" class="text-sm font-medium text-gray-700">Executive trigger</label>
                <select
                  id="executive_trigger-{{t.id}}"
                  name="executive_trigger-{{t.id}}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                    {% for opt in ["low", "medium", "high"] %}
                      <option value="{{ opt }}" {% if t.executive_trigger == opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                  </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="recurrence-{{t.id}}" class="text-sm font-medium text-gray-700">Recurrence</label>
                <select
                  id="recurrence-{{t.id}}"
                  name="recurrence-{{t.id}}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                    <option value="" {% if not t.recurrence %}selected{% endif %}></option>
                    {% for opt in ["daily", "weekly", "monthly", "yearly"] %}
                      <option value="{{ opt }}" {% if t.recurrence == opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                  </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="last_completed-{{t.id}}" class="text-sm font-medium text-gray-700">Last completed</label>
                <input
                  id="last_completed-{{t.id}}"
                  type="date"
                  name="last_completed-{{t.id}}"
                  value="{{ t.last_completed or ''}}"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
              </div>
            </div>
          </fieldset>
        </div>
      </details>
      {% endfor %}
      </div>
      <div class="sticky bottom-0 z-20 border-t border-gray-200 bg-white/95 px-4 py-2 backdrop-blur flex justify-end gap-3 rounded-b-3xl">
        <a
          href="{{ url_for('tasks_page') }}"
          class="inline-flex items-center rounded-lg border border-indigo-200 bg-indigo-50 px-4 py-2 text-sm font-medium text-indigo-700 transition hover:bg-indigo-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-200"
        >
          Cancel
        </a>
        <button
          type="submit"
          class="inline-flex items-center rounded-xl bg-amber-300 px-5 py-2 text-sm font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200"
        >
          Save changes
        </button>
      </div>
      <datalist id="areas">
        {% for a in area_options %}
          <option value="{{ a }}">
        {% endfor %}
      </datalist>
      <datalist id="projects">
        {% for p in project_options %}
          <option value="{{ p }}">
        {% endfor %}
      </datalist>
      <datalist id="task-types">
        {% for tp in type_options %}
          <option value="{{ tp }}">
        {% endfor %}
      </datalist>
    </form>
    <button
      type="button"
      id="scrollToNewTaskBtn"
      class="fixed bottom-6 right-6 z-30 inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400 lg:hidden"
      aria-label="Jump to the new task form"
    >
      + New Task
    </button>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-task-details]').forEach((detailsEl) => {
          const summary = detailsEl.querySelector('summary[aria-controls]');
          if (!summary) return;
          const controlsId = summary.getAttribute('aria-controls');
          const controlled = controlsId ? document.getElementById(controlsId) : null;
          if (!summary.id && controlsId) {
            summary.id = `summary-${controlsId}`;
          }
          if (controlled) {
            controlled.setAttribute('role', 'region');
            controlled.setAttribute('aria-labelledby', summary.id);
          }

          const syncState = () => {
            summary.setAttribute('aria-expanded', detailsEl.open ? 'true' : 'false');
            if (controlled) {
              controlled.setAttribute('aria-hidden', detailsEl.open ? 'false' : 'true');
            }
          };

          detailsEl.addEventListener('toggle', syncState);
          syncState();
        });

        const manageTasksForm = document.getElementById('manage-tasks-form');
        const newTaskForm = document.getElementById('newTaskForm');
        const newTaskFeedback = document.getElementById('newTaskFeedback');
        const newTaskTitle = document.getElementById('newTaskTitle');
        const createTaskBtn = document.getElementById('createTaskBtn');
        const newTaskProject = document.getElementById('newTaskProject');
        const newTaskArea = document.getElementById('newTaskArea');
        const newTaskType = document.getElementById('newTaskType');
        const newTaskEffort = document.getElementById('newTaskEffort');
        const newTaskStatus = document.getElementById('newTaskStatus');
        const newTaskDue = document.getElementById('newTaskDue');
        const newTaskRecurrence = document.getElementById('newTaskRecurrence');
        const newTaskEnergy = document.getElementById('newTaskEnergy');
        const newTaskNotes = document.getElementById('newTaskNotes');
        const newTaskAdvanced = document.getElementById('newTaskAdvanced');
        const scrollToNewTaskBtn = document.getElementById('scrollToNewTaskBtn');

        if (newTaskTitle) {
          attachFieldValidation(newTaskTitle);
        }

        const requiredTaskFields = [{ element: newTaskTitle, message: 'Task title is required.' }];

        if (newTaskForm && createTaskBtn) {
          const submitTask = performActionWithFeedback(createTaskBtn, {
            loadingText: 'Creating…',
            errorMessage: 'Unable to create task',
            action: async () => {
              clearFeedback(newTaskFeedback);
              const ok = validateRequiredFields(requiredTaskFields, {
                feedbackEl: newTaskFeedback,
                summaryMessage: 'Add a task title before saving.',
              });
              if (!ok) {
                return null;
              }

              const payload = {
                title: (newTaskTitle?.value || '').trim(),
                effort: (newTaskEffort?.value || 'low').trim(),
                status: (newTaskStatus?.value || 'active').trim(),
              };

              const optionalTextFields = [
                { element: newTaskProject, key: 'project' },
                { element: newTaskArea, key: 'area' },
                { element: newTaskType, key: 'type' },
                { element: newTaskRecurrence, key: 'recurrence' },
              ];
              optionalTextFields.forEach(({ element, key }) => {
                if (!element) {
                  return;
                }
                const value = (element.value || '').trim();
                if (value) {
                  payload[key] = value;
                }
              });

              if (newTaskDue && newTaskDue.value) {
                payload.due = newTaskDue.value;
              }

              if (newTaskEnergy && newTaskEnergy.value) {
                const parsedEnergy = Number.parseInt(newTaskEnergy.value, 10);
                if (!Number.isNaN(parsedEnergy)) {
                  payload.energy_cost = parsedEnergy;
                }
              }

              const notesValue = (newTaskNotes?.value || '').trim();
              if (notesValue) {
                payload.notes = notesValue;
              }

              const res = await fetch('/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              ensureOkResponse(res);
              await res.json();
              updateFeedback(newTaskFeedback, 'Task created successfully. Refreshing the list…', 'success');
              if (newTaskAdvanced) {
                newTaskAdvanced.open = false;
              }
              setTimeout(() => {
                window.location.reload();
              }, 600);
              return null;
            },
          });

          newTaskForm.addEventListener('submit', (event) => {
            event.preventDefault();
            submitTask();
          });

          newTaskForm.addEventListener('reset', () => {
            clearFeedback(newTaskFeedback);
            setTimeout(() => {
              if (newTaskTitle) {
                setFieldValidity(newTaskTitle, true);
              }
              if (newTaskAdvanced) {
                newTaskAdvanced.open = false;
              }
            }, 0);
          });
        }

        if (manageTasksForm) {
          const deleteButtons = manageTasksForm.querySelectorAll('[data-delete-button]');
          const submitManageTasksForm = () => {
            if (typeof manageTasksForm.requestSubmit === 'function') {
              manageTasksForm.requestSubmit();
            } else {
              manageTasksForm.submit();
            }
          };
          deleteButtons.forEach((button) => {
            button.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const taskId = button.getAttribute('data-task-id');
              if (!taskId) {
                return;
              }
              const deleteInput = manageTasksForm.querySelector(
                `[data-delete-input][data-task-id="${taskId}"]`
              );
              if (deleteInput) {
                deleteInput.value = '1';
              }
              const taskDetails = button.closest('[data-task-details]');
              if (taskDetails) {
                taskDetails.remove();
              }
            });
          });

          const recurrenceDays = {
            daily: 1,
            weekly: 7,
            monthly: 30,
            yearly: 365,
          };
          const statusRowStyles = {
            complete: ['border', 'border-green-200', 'bg-green-50/70', 'hover:bg-green-50/70'],
            active: ['border', 'border-blue-200', 'bg-blue-50/70', 'hover:bg-indigo-50/40'],
            blocked: ['border', 'border-rose-200', 'bg-rose-50/70', 'hover:bg-rose-50/70'],
            waiting: ['border', 'border-amber-200', 'bg-amber-50/70', 'hover:bg-amber-50/70'],
          };
          const defaultRowClasses = ['border', 'border-gray-200', 'bg-white/90', 'hover:bg-indigo-50/40'];
          const allRowClassSet = new Set(defaultRowClasses);
          Object.values(statusRowStyles).forEach((styleList) => {
            styleList.forEach((cls) => allRowClassSet.add(cls));
          });
          const allRowClasses = [...allRowClassSet];
          const updateSummaryStyle = (taskId, status) => {
            const summary = manageTasksForm.querySelector(
              `[data-task-summary][data-task-id="${taskId}"]`
            );
            if (!summary) {
              return;
            }
            allRowClasses.forEach((cls) => summary.classList.remove(cls));
            const styleClasses = statusRowStyles[status] || defaultRowClasses;
            summary.classList.add(...styleClasses);
            summary.dataset.taskStatus = status;
          };
          const completeButtons = manageTasksForm.querySelectorAll('[data-complete-button]');
          completeButtons.forEach((button) => {
            button.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const taskId = button.getAttribute('data-task-id');
              if (!taskId) {
                return;
              }

              const today = new Date();
              const localDate = [
                today.getFullYear(),
                String(today.getMonth() + 1).padStart(2, '0'),
                String(today.getDate()).padStart(2, '0')
              ].join('-');
              const lastCompletedInput = document.getElementById(`last_completed-${taskId}`);
              if (lastCompletedInput) {
                lastCompletedInput.value = localDate;
              }

              const statusSelect = document.getElementById(`status-${taskId}`);
              const recurrenceInput = document.getElementById(`recurrence-${taskId}`);
              const isRecurring = Boolean(recurrenceInput?.value?.trim());
              const recurrenceKey = (recurrenceInput?.value || '').trim().toLowerCase();
              const daysToAdd = recurrenceDays[recurrenceKey];
              const dueInput = document.getElementById(`due-${taskId}`);
              if (daysToAdd && dueInput) {
                const nextDueDate = new Date(localDate);
                nextDueDate.setDate(nextDueDate.getDate() + daysToAdd);
                dueInput.value = nextDueDate.toISOString().slice(0, 10);
              }
              const nextStatus = isRecurring ? 'active' : 'complete';
              if (statusSelect) {
                statusSelect.value = nextStatus;
              }

              const statusPill = manageTasksForm.querySelector(
                `[data-status-pill][data-task-id="${taskId}"]`
              );
              if (statusPill) {
                statusPill.textContent = isRecurring ? 'Active' : 'Complete';
              }
              updateSummaryStyle(taskId, nextStatus);
              button.disabled = true;
              submitManageTasksForm();
            });
          });
        }

        if (scrollToNewTaskBtn && newTaskForm) {
          scrollToNewTaskBtn.addEventListener('click', () => {
            newTaskForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (newTaskTitle) {
              setTimeout(() => {
                newTaskTitle.focus();
              }, 250);
            }
          });
        }
      });
    </script>
  </div>
{% endblock %}
