{% extends "base.html" %}
{% block title %}Edit Tasks{% endblock %}
{% block content %}
  <div class="max-w-5xl mx-auto space-y-8 lg:grid lg:grid-cols-[minmax(18rem,22rem)_1fr] lg:gap-8 lg:space-y-0">
    <div class="lg:hidden">
      <div class="flex items-center justify-between gap-4 rounded-3xl border border-gray-200 bg-white/90 px-4 py-3 shadow-sm">
        <div>
          <p class="text-sm font-semibold text-slate-900">Filters</p>
          <p class="text-xs text-slate-500">Show or hide the filter drawer while you browse tasks.</p>
        </div>
        <button
          type="button"
          class="rounded-full border border-indigo-200 bg-indigo-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400"
          aria-controls="manage-filters-panel"
          aria-expanded="false"
          data-filter-toggle
        >
          <span data-filter-toggle-label>Show filters</span>
        </button>
      </div>
    </div>
    <aside class="space-y-8 lg:space-y-6">
      <div class="space-y-6 lg:sticky lg:top-6 lg:self-start lg:z-20">
        <section
          id="manage-filters-panel"
          class="hidden bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-500 text-white rounded-3xl shadow-2xl p-8 space-y-6 lg:block"
          data-mobile-filter-panel
        >
          <div class="space-y-2">
            <h1 class="text-3xl font-bold">Curate your task list</h1>
            <p class="text-lg text-indigo-100">
              Filter and refine every detail while staying in the same ambient flow as the Mindloom home experience.
            </p>
          </div>
          <form method="get" class="rounded-2xl border border-white/20 bg-white/10 p-5 backdrop-blur space-y-6">
            {% if selected_due_on %}
            <input type="hidden" name="due_on" value="{{ selected_due_on }}" />
            <div class="flex items-center gap-2 rounded-xl border border-amber-200 bg-amber-100/40 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-amber-800">
              Filtering tasks due on or before {{ selected_due_on }}
            </div>
            {% endif %}
            <div class="space-y-1">
              <label for="task-search" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Search</label>
              <input
                id="task-search"
                type="search"
                name="q"
                value="{{ search_query or '' }}"
                placeholder="Search tasks"
                class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white placeholder-indigo-200 focus:ring-2 focus:ring-amber-300 focus:outline-none"
              />
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="status-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Status</label>
                <select
                  id="status-filter"
                  name="status"
                  class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
                >
                  <option value="" class="text-gray-900">All</option>
                  {% for opt in status_options %}
                    <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_status == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="project-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Project</label>
                <select
                  id="project-filter"
                  name="project"
                  class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
                >
                  <option value="" class="text-gray-900">All</option>
                  {% for opt in project_options %}
                    <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_project == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="area-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Area</label>
                <select
                  id="area-filter"
                  name="area"
                  class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
                >
                  <option value="" class="text-gray-900">All</option>
                  {% for opt in area_options %}
                    <option value="{{ opt }}" style="color: #111827;" class="text-gray-900" {% if selected_area == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="flex flex-col gap-1">
                <label for="sort-filter" class="text-xs font-semibold uppercase tracking-wide text-indigo-100">Sort</label>
                <select
                  id="sort-filter"
                  name="sort"
                  class="rounded-xl border-0 bg-white/20 px-3 py-2 text-sm text-white focus:ring-2 focus:ring-amber-300 focus:outline-none"
                >
                  {% for value, label in sort_options %}
                    <option value="{{ value }}" style="color: #111827;" class="text-gray-900" {% if selected_sort == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="flex flex-wrap items-center justify-end gap-3">
              <a
                href="{{ url_for('manage_tasks_page') }}"
                class="inline-flex items-center justify-center rounded-lg border border-white/30 bg-white/10 px-4 py-2 text-sm font-medium text-white transition hover:bg-white/20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
              >
                Clear filters
              </a>
              <button
                type="submit"
                class="inline-flex items-center justify-center gap-2 rounded-xl bg-amber-300 px-5 py-2 text-sm font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200"
              >
                Apply filters
              </button>
            </div>
          </form>
        </section>
      </div>
    </aside>
    <form method="post" id="manage-tasks-form" class="flex flex-col rounded-3xl border border-gray-200 bg-white/80 shadow-sm">
      <input type="hidden" name="q" value="{{ search_query or '' }}" />
      <input type="hidden" name="status" value="{{ selected_status or '' }}" />
      <input type="hidden" name="project" value="{{ selected_project or '' }}" />
      <input type="hidden" name="area" value="{{ selected_area or '' }}" />
      <input type="hidden" name="sort" value="{{ selected_sort or '' }}" />
      <section class="space-y-4 border-b border-gray-200 bg-slate-50/70 px-4 py-4 md:px-6">
        <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-sm font-semibold text-slate-800">Bulk edit</p>
            <p class="text-xs text-slate-500">
              <span data-selection-count>0</span> of {{ total_tasks }} selected
            </p>
            <p class="text-xs text-slate-500">Choose a value then click the icon—each change saves immediately and reloads the list.</p>
          </div>
          <div class="flex flex-wrap gap-2 text-xs font-medium">
            <button
              type="button"
              data-select-all
              class="rounded-full border border-slate-200 bg-white px-3 py-1 text-slate-700 transition hover:border-slate-300"
            >
              Select all
            </button>
          </div>
        </div>
        <div class="lg:hidden">
          <button
            type="button"
            class="flex w-full items-center justify-between gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-700 transition hover:border-slate-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400"
            aria-controls="bulk-edit-panel"
            aria-expanded="false"
            data-bulk-toggle
          >
            <span data-bulk-toggle-label>Show bulk edit options</span>
            <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6" />
            </svg>
          </button>
        </div>
        <div data-bulk-panel id="bulk-edit-panel" class="hidden space-y-3 lg:block">
          <div class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
            <div class="flex flex-col gap-2">
              <label for="bulkStatus" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Status</label>
              <div class="flex gap-2">
                <select
                  id="bulkStatus"
                  data-bulk-target="status"
                  class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                  <option value="">Set status</option>
                  {% for opt in status_options %}
                    <option value="{{ opt }}">{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <label for="bulkProject" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Project</label>
              <div class="flex gap-2">
                <input
                  id="bulkProject"
                  type="text"
                  list="projects"
                  data-bulk-target="project"
                  data-bulk-allow-empty
                  class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Type to filter"
                >
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <label for="bulkArea" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Area</label>
              <div class="flex gap-2">
                <input
                  id="bulkArea"
                  type="text"
                  list="areas"
                  data-bulk-target="area"
                  data-bulk-allow-empty
                  class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  placeholder="Type to filter"
                >
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <label for="bulkEffort" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Effort</label>
              <div class="flex gap-2">
                <select
                  id="bulkEffort"
                  data-bulk-target="effort"
                  class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
                  <option value="">Set effort</option>
                  {% for opt in ["low", "medium", "high"] %}
                    <option value="{{ opt }}">{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <label for="bulkDue" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Due date</label>
              <div class="flex gap-2">
                <input
                  id="bulkDue"
                  type="date"
                  data-bulk-target="due"
                  data-bulk-allow-empty
                  class="flex-1 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                >
              </div>
            </div>
          </div>
          <div class="mt-3 flex justify-end">
            <button
              type="button"
              data-bulk-apply-all
              class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-600 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400"
            >
              Apply selected changes
              <svg
                class="h-3.5 w-3.5"
                viewBox="0 0 20 20"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M5 11l3 3 7-7" />
              </svg>
            </button>
          </div>
        </div>
      </section>
      <div
        class="divide-y divide-gray-200 pt-3"
        data-task-list
        data-chunk-size="{{ chunk_size }}"
        data-next-offset="{{ tasks|length }}"
        data-total-tasks="{{ total_tasks }}"
      >
        {% include "partials/manage_tasks_list.html" %}
      </div>
      <div class="py-4 text-center text-xs uppercase tracking-[0.2em] text-slate-400" data-task-loading hidden>
        Loading more tasks…
      </div>
      <div data-task-load-trigger class="h-4"></div>
      <div class="sticky bottom-0 z-20 border-t border-gray-200 bg-white/95 px-4 py-2 backdrop-blur flex justify-end gap-3 rounded-b-3xl">
        <button
          type="button"
          data-open-new-task-modal
          class="hidden items-center rounded-xl bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow-lg transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400 lg:inline-flex"
          aria-label="Open new task modal"
        >
          + Add task
        </button>
        <button
          type="submit"
          class="inline-flex items-center rounded-xl bg-amber-300 px-5 py-2 text-sm font-semibold text-gray-900 shadow-lg transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-200"
        >
          Save changes
        </button>
      </div>
      <datalist id="areas">
        {% for a in area_options %}
          <option value="{{ a }}">
        {% endfor %}
      </datalist>
      <datalist id="projects">
        {% for p in project_options %}
          <option value="{{ p }}">
        {% endfor %}
      </datalist>
    </form>
    <button
      type="button"
      data-open-new-task-modal
      class="fixed bottom-20 right-6 z-30 inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg transition hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400 lg:hidden"
      aria-label="Open new task modal"
    >
      + New Task
    </button>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const initializeTaskDetails = (scope = document) => {
          scope.querySelectorAll('[data-task-details]').forEach((detailsEl) => {
            if (detailsEl.dataset.detailsInit === 'true') {
              return;
            }
            const summary = detailsEl.querySelector('summary[aria-controls]');
            if (!summary) {
              return;
            }
            const controlsId = summary.getAttribute('aria-controls');
            const controlled = controlsId ? document.getElementById(controlsId) : null;
            if (!summary.id && controlsId) {
              summary.id = `summary-${controlsId}`;
            }
            if (controlled) {
              controlled.setAttribute('role', 'region');
              controlled.setAttribute('aria-labelledby', summary.id);
            }

            const syncState = () => {
              summary.setAttribute('aria-expanded', detailsEl.open ? 'true' : 'false');
              if (controlled) {
                controlled.setAttribute('aria-hidden', detailsEl.open ? 'false' : 'true');
              }
            };

            detailsEl.addEventListener('toggle', syncState);
            syncState();
            detailsEl.dataset.detailsInit = 'true';
          });
        };

        initializeTaskDetails();

        const filterToggleButton = document.querySelector('[data-filter-toggle]');
        const mobileFilterPanel = document.querySelector('[data-mobile-filter-panel]');
        if (filterToggleButton && mobileFilterPanel) {
          const filterToggleLabel = filterToggleButton.querySelector('[data-filter-toggle-label]');
          const updateFilterToggle = (open) => {
            filterToggleButton.setAttribute('aria-expanded', String(open));
            if (filterToggleLabel) {
              filterToggleLabel.textContent = open ? 'Hide filters' : 'Show filters';
            }
          };
          updateFilterToggle(false);
          filterToggleButton.addEventListener('click', () => {
            const panelHidden = mobileFilterPanel.classList.toggle('hidden');
            updateFilterToggle(!panelHidden);
          });
        }

        const manageTasksForm = document.getElementById('manage-tasks-form');

        if (manageTasksForm) {
          const submitManageTasksForm = () => {
            if (typeof manageTasksForm.requestSubmit === 'function') {
              manageTasksForm.requestSubmit();
            } else {
              manageTasksForm.submit();
            }
          };
          const toggleSelectButton = manageTasksForm.querySelector('[data-select-all]');
          const selectionCountEl = manageTasksForm.querySelector('[data-selection-count]');
          const highlightClasses = ['ring-2', 'ring-indigo-400/60', 'bg-indigo-50/70'];
          const statusRowStyles = {
            complete: ['border', 'border-green-200', 'bg-green-50/70', 'hover:bg-green-50/70'],
            active: ['border', 'border-blue-200', 'bg-blue-50/70', 'hover:bg-indigo-50/40'],
            blocked: ['border', 'border-rose-200', 'bg-rose-50/70', 'hover:bg-rose-50/70'],
            waiting: ['border', 'border-amber-200', 'bg-amber-50/70', 'hover:bg-amber-50/70'],
          };
          const defaultRowClasses = ['border', 'border-gray-200', 'bg-white/90', 'hover:bg-indigo-50/40'];
          const allRowClassSet = new Set(defaultRowClasses);
          Object.values(statusRowStyles).forEach((styleList) => {
            styleList.forEach((cls) => allRowClassSet.add(cls));
          });
          const allRowClasses = [...allRowClassSet];
          const updateSummaryStyle = (taskId, status) => {
            const summary = manageTasksForm.querySelector(
              `[data-task-summary][data-task-id="${taskId}"]`
            );
            if (!summary) {
              return;
            }
            allRowClasses.forEach((cls) => summary.classList.remove(cls));
            const styleClasses = statusRowStyles[status] || defaultRowClasses;
            summary.classList.add(...styleClasses);
            summary.dataset.taskStatus = status;
          };
          const setSummarySelection = (taskId, selected) => {
            if (!taskId) {
              return;
            }
            const summary = manageTasksForm.querySelector(
              `[data-task-summary][data-task-id="${taskId}"]`
            );
            if (!summary) {
              return;
            }
            if (selected) {
              summary.classList.add(...highlightClasses);
            } else {
              summary.classList.remove(...highlightClasses);
            }
          };
          const getBulkCheckboxes = () => manageTasksForm.querySelectorAll('[data-bulk-checkbox]');
          const areAllSelected = () => {
            const checkboxes = getBulkCheckboxes();
            return checkboxes.length > 0 && Array.from(checkboxes).every((checkbox) => checkbox.checked);
          };
          const updateSelectAllToggleLabel = () => {
            if (!toggleSelectButton) {
              return;
            }
            toggleSelectButton.textContent = areAllSelected() ? 'Deselect all' : 'Select all';
          };
          const updateSelectionCount = () => {
            const selectedCount = Array.from(getBulkCheckboxes()).filter((checkbox) => checkbox.checked).length;
            if (selectionCountEl) {
              selectionCountEl.textContent = selectedCount;
            }
            updateSelectAllToggleLabel();
          };
          const toggleSelection = (value) => {
            getBulkCheckboxes().forEach((checkbox) => {
              checkbox.checked = value;
              setSummarySelection(checkbox.getAttribute('data-task-id'), value);
            });
            updateSelectionCount();
          };
          const getSelectedTaskIds = () =>
            Array.from(getBulkCheckboxes())
              .filter((checkbox) => checkbox.checked)
              .map((checkbox) => checkbox.getAttribute('data-task-id'))
              .filter(Boolean);
          const applyBulkField = (field, value, allowEmpty = false) => {
            if (!field) {
              return false;
            }
            const normalizedValue = value == null ? '' : String(value).trim();
            if (!allowEmpty && !normalizedValue) {
              return false;
            }
            let applied = false;
            getSelectedTaskIds().forEach((taskId) => {
              const targetInput = manageTasksForm.querySelector(`[name="${field}-${taskId}"]`);
              if (!targetInput) {
                return;
              }
              targetInput.value = normalizedValue;
              targetInput.dispatchEvent(new Event('input', { bubbles: true }));
              targetInput.dispatchEvent(new Event('change', { bubbles: true }));
              applied = true;
            });
            return applied;
          };
          const bulkFieldConfigs = [
            { field: 'status', allowEmpty: false },
            { field: 'project', allowEmpty: true },
            { field: 'area', allowEmpty: true },
            { field: 'effort', allowEmpty: false },
            { field: 'due', allowEmpty: true },
          ];
          const applyAllButton = manageTasksForm.querySelector('[data-bulk-apply-all]');
          if (applyAllButton) {
            applyAllButton.addEventListener('click', (event) => {
              event.preventDefault();
              let appliedAny = false;
              bulkFieldConfigs.forEach(({ field, allowEmpty }) => {
                const sourceControl = manageTasksForm.querySelector(`[data-bulk-target="${field}"]`);
                if (!sourceControl) {
                  return;
                }
                const allow = allowEmpty || sourceControl.hasAttribute('data-bulk-allow-empty');
                const applied = applyBulkField(field, sourceControl.value, allow);
                if (applied) {
                  appliedAny = true;
                }
              });
              if (appliedAny) {
                submitManageTasksForm();
              }
            });
          }
          const recurrenceDays = {
            daily: 1,
            weekly: 7,
            "bi-weekly": 14,
            monthly: 30,
            quarterly: 91,
            "bi-annual": 182,
            yearly: 365,
          };
          manageTasksForm.addEventListener('change', (event) => {
            const target = event.target;
            if (!target || !target.matches || !target.matches('[data-bulk-checkbox]')) {
              return;
            }
            const taskId = target.getAttribute('data-task-id');
            setSummarySelection(taskId, target.checked);
            updateSelectionCount();
          });
          manageTasksForm.addEventListener('click', (event) => {
            const deleteButton = event.target.closest('[data-delete-button]');
            if (deleteButton) {
              event.preventDefault();
              event.stopPropagation();
              const taskId = deleteButton.getAttribute('data-task-id');
              if (taskId) {
                const deleteInput = manageTasksForm.querySelector(`[data-delete-input][data-task-id="${taskId}"]`);
                if (deleteInput) {
                  deleteInput.value = '1';
                }
                const taskDetails = deleteButton.closest('[data-task-details]');
                if (taskDetails) {
                  taskDetails.remove();
                  updateSelectionCount();
                }
              }
              return;
            }
            const completeButton = event.target.closest('[data-complete-button]');
            if (completeButton) {
              event.preventDefault();
              event.stopPropagation();
              const taskId = completeButton.getAttribute('data-task-id');
              if (!taskId) {
                return;
              }

              const today = new Date();
              const localDate = [
                today.getFullYear(),
                String(today.getMonth() + 1).padStart(2, '0'),
                String(today.getDate()).padStart(2, '0'),
              ].join('-');
              const lastCompletedInput = document.getElementById(`last_completed-${taskId}`);
              if (lastCompletedInput) {
                lastCompletedInput.value = localDate;
              }

              const statusSelect = document.getElementById(`status-${taskId}`);
              const recurrenceInput = document.getElementById(`recurrence-${taskId}`);
              const isRecurring = Boolean(recurrenceInput?.value?.trim());
              const recurrenceKey = (recurrenceInput?.value || '').trim().toLowerCase();
              const daysToAdd = recurrenceDays[recurrenceKey];
              const dueInput = document.getElementById(`due-${taskId}`);
              if (daysToAdd && dueInput) {
                const nextDueDate = new Date(localDate);
                nextDueDate.setDate(nextDueDate.getDate() + daysToAdd);
                dueInput.value = nextDueDate.toISOString().slice(0, 10);
              }
              const nextStatus = isRecurring ? 'active' : 'complete';
              if (statusSelect) {
                statusSelect.value = nextStatus;
              }

              const statusPill = manageTasksForm.querySelector(
                `[data-status-pill][data-task-id="${taskId}"]`
              );
              if (statusPill) {
                statusPill.textContent = isRecurring ? 'Active' : 'Complete';
              }
              updateSummaryStyle(taskId, nextStatus);
              completeButton.disabled = true;
              submitManageTasksForm();
              return;
            }
          });
          if (toggleSelectButton) {
            toggleSelectButton.addEventListener('click', (event) => {
              event.preventDefault();
              const allSelected = areAllSelected();
              toggleSelection(!allSelected);
            });
          }
          updateSelectionCount();
          const bulkToggle = manageTasksForm.querySelector('[data-bulk-toggle]');
          const bulkPanel = manageTasksForm.querySelector('[data-bulk-panel]');
          if (bulkToggle && bulkPanel) {
            const bulkToggleLabel = bulkToggle.querySelector('[data-bulk-toggle-label]');
            const updateBulkToggle = (open) => {
              bulkToggle.setAttribute('aria-expanded', String(open));
              if (bulkToggleLabel) {
                bulkToggleLabel.textContent = open ? 'Hide bulk edit options' : 'Show bulk edit options';
              }
            };
            updateBulkToggle(false);
            bulkToggle.addEventListener('click', () => {
              const panelHidden = bulkPanel.classList.toggle('hidden');
              updateBulkToggle(!panelHidden);
            });
          }
        }

        const taskList = document.querySelector('[data-task-list]');
        const taskLoadTrigger = document.querySelector('[data-task-load-trigger]');
        const taskLoadingIndicator = document.querySelector('[data-task-loading]');
        if (taskList && taskLoadTrigger) {
          const chunkSize = Math.max(1, Number(taskList.dataset.chunkSize) || 1);
          let nextOffset = Number(taskList.dataset.nextOffset) || 0;
          const totalTasks = Number(taskList.dataset.totalTasks) || 0;
          if (nextOffset >= totalTasks) {
            taskLoadTrigger.remove();
            if (taskLoadingIndicator) {
              taskLoadingIndicator.setAttribute('hidden', '');
            }
          } else {
            let isLoading = false;
            let observer;
            const loadMoreTasks = async () => {
              if (isLoading || nextOffset >= totalTasks) {
                return;
              }
              isLoading = true;
              if (taskLoadingIndicator) {
                taskLoadingIndicator.removeAttribute('hidden');
              }
              try {
                const params = new URLSearchParams(window.location.search);
                params.set('offset', String(nextOffset));
                params.set('limit', String(chunkSize));
                const response = await fetch(`/manage-tasks-chunk?${params.toString()}`);
                ensureOkResponse(response);
                const payload = await response.json();
                if (payload?.html) {
                  const wrapper = document.createElement('template');
                  wrapper.innerHTML = payload.html;
                  taskList.appendChild(wrapper.content);
                  initializeTaskDetails(taskList);
                }
                nextOffset = payload?.nextOffset ?? nextOffset + chunkSize;
                taskList.dataset.nextOffset = nextOffset;
                if (!payload?.hasMore || nextOffset >= totalTasks) {
                  observer?.disconnect();
                  taskLoadTrigger.remove();
                }
              } catch (error) {
                console.error('Unable to load more tasks', error);
              } finally {
                isLoading = false;
                if (taskLoadingIndicator) {
                  taskLoadingIndicator.setAttribute('hidden', '');
                }
              }
            };
            observer = new IntersectionObserver(
              (entries) => {
                if (entries.some((entry) => entry.isIntersecting)) {
                  loadMoreTasks();
                }
              },
              { rootMargin: '200px' }
            );
            observer.observe(taskLoadTrigger);
          }
        }

      });
    </script>

  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const tzOffsetMs = now.getTimezoneOffset() * 60_000;
      const localDate = new Date(now.getTime() - tzOffsetMs).toISOString().slice(0, 10);
      const params = new URLSearchParams(window.location.search);
      const queryToday = params.get('today');
      if (queryToday === localDate) {
        return;
      }
      params.set('today', localDate);
      const nextUrl = `${window.location.pathname}?${params.toString()}`;
      window.location.replace(nextUrl);
    });
  </script>
{% endblock %}
